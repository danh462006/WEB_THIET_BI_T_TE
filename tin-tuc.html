<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tin t·ª©c - Ki·∫øn th·ª©c | ƒê·ª©c Ph∆∞∆°ng Medical</title>
    <link rel="icon" type="image/png" href="hinh-anh/logo-favicon.png">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="category-style.css">
    <link rel="stylesheet" href="profile-modal.css">
    <link rel="stylesheet" href="mobile-responsive.css">
    <script src="auth-redirect.js?v=2"></script>
    <script src="profile-modal.js?v=2"></script>
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="logo-section">
                <img src="hinh-anh/logo.png" alt="TBYT ƒê·ª©c Ph∆∞∆°ng" class="logo">
            </div>
            <div class="search-section">
                <div class="search-box">
                    <input type="text" placeholder="T√¨m Ki·∫øm ..." class="search-input" autocomplete="off" readonly onfocus="this.removeAttribute('readonly'); this.value='';" name="search_q_xyz" id="searchQuery">
                    <button class="search-btn">üîç</button>
                </div>
                <div class="search-suggestions" id="searchSuggestions"></div>
            </div>
            <div class="user-section">
                <div class="account-dropdown">
                    <button class="account-btn" onclick="handleAccountClick(event)">
                        <img src="hinh-anh/icon_tk.png" alt="T√†i kho·∫£n" class="account-icon">
                    </button>
                    <div id="usernameDisplay" class="username-display" style="display: none;"></div>
                    <div class="account-menu" id="accountMenu" style="min-width: 150px; right: 0; left: auto;">
                        <a href="#" onclick="event.stopPropagation(); openProfileModal(); return false;">Th√¥ng tin t√†i kho·∫£n</a>
                        <a href="#">ƒê∆°n h√†ng c·ªßa t√¥i</a>
                        <a href="#" onclick="handleLogout(); return false;">ƒêƒÉng xu·∫•t</a>
                    </div>
                </div>
                <button class="cart-btn">üõí Gi·ªè h√†ng</button>
                <div class="dropdown">
                    <button class="dropdown-btn">üìã Danh m·ª•c ‚ñº</button>
                    <div class="dropdown-content">
                        <a href="index.html">Trang ch·ªß</a>
                        <div class="dropdown-item-with-submenu">
                            <a href="#" class="has-submenu">S·∫£n ph·∫©m</a>
                            <div class="submenu">
                                <div class="submenu-content">
                                    <div class="category-header">
                                        <h3>üî• G·ª£i √Ω cho b·∫°n</h3>
                                    </div>
                                    <div class="category-brands">
                                        <div class="brand-item" data-category="Gi∆∞·ªùng"><img src="icon-hinhdanhmuc/nhom-giuong.png" alt="Gi∆∞·ªùng" class="category-icon">Gi∆∞·ªùng</div>
                                        <div class="brand-item" data-category="Xe lƒÉn"><img src="icon-hinhdanhmuc/nhom-xelan.png" alt="Xe lƒÉn" class="category-icon">Xe lƒÉn</div>
                                        <div class="brand-item" data-category="Xe Scooter ƒëi·ªán"><img src="icon-hinhdanhmuc/nhom-xedien.png" alt="Xe Scooter ƒëi·ªán" class="category-icon">Xe Scooter ƒëi·ªán</div>
                                        <div class="brand-item" data-category="BƒÉng ca"><img src="icon-hinhdanhmuc/nhom-bangca.png" alt="BƒÉng ca" class="category-icon">BƒÉng ca</div>
                                        <div class="brand-item" data-category="T·ªß"><img src="icon-hinhdanhmuc/nhom-tu.png" alt="T·ªß" class="category-icon">T·ªß</div>
                                        <div class="brand-item" data-category="M√°y t·∫°o oxy"><img src="icon-hinhdanhmuc/nhom-maytaooxy.png" alt="M√°y t·∫°o oxy" class="category-icon">M√°y t·∫°o oxy</div>
                                        <div class="brand-item" data-category="M√°y ƒëo"><img src="icon-hinhdanhmuc/nhom-maydo.png" alt="M√°y ƒëo" class="category-icon">M√°y ƒëo</div>
                                        <div class="brand-item" data-category="M√°y x√¥ng"><img src="icon-hinhdanhmuc/nhom-xong.png" alt="M√°y x√¥ng" class="category-icon">M√°y x√¥ng</div>
                                        <div class="brand-item" data-category="M√°y h√∫t d·ªãch"><img src="icon-hinhdanhmuc/nhom-mayhutdich.png" alt="M√°y h√∫t d·ªãch" class="category-icon">M√°y h√∫t d·ªãch</div>
                                        <div class="brand-item" data-category="M√°y massage"><img src="icon-hinhdanhmuc/nhom-massage.png" alt="M√°y massage" class="category-icon">M√°y massage</div>
                                        <div class="brand-item" data-category="Thi·∫øt b·ªã t·∫≠p"><img src="icon-hinhdanhmuc/nhom-maytap.png" alt="Thi·∫øt b·ªã t·∫≠p" class="category-icon">Thi·∫øt b·ªã t·∫≠p</div>
                                        <div class="brand-item" data-category="N·ªám"><img src="icon-hinhdanhmuc/nhom-nem.png" alt="N·ªám" class="category-icon">N·ªám</div>
                                        <div class="brand-item" data-category="D·ª•ng c·ª• h·ªó tr·ª£"><img src="icon-hinhdanhmuc/nhom-dungcuhotro.png" alt="D·ª•ng c·ª• h·ªó tr·ª£" class="category-icon">D·ª•ng c·ª• h·ªó tr·ª£</div>
                                        <div class="brand-item" data-category="Thi·∫øt b·ªã y t·∫ø kh√°c"><img src="icon-hinhdanhmuc/nhom-thietbiyte.png" alt="Thi·∫øt b·ªã y t·∫ø kh√°c" class="category-icon">Thi·∫øt b·ªã y t·∫ø kh√°c</div>
                                    </div>
                                    <div class="category-main">
                                        <div class="category-detail" id="categoryDetail">
                                            <p>Di chu·ªôt v√†o c√°c nh√≥m s·∫£n ph·∫©m ·ªü tr√™n ƒë·ªÉ xem chi ti·∫øt</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <a href="thong-tin.html">Gi·ªõi thi·ªáu</a>
                        <a href="tin-tuc.html">Tin t·ª©c - Ki·∫øn th·ª©c</a>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Login Modal (copy from trang ch·ªß) -->
    <div id="loginModal" class="modal" style="display:none;">
        <div class="modal-content">
            <span class="close" onclick="closeLoginForm()">&times;</span>
            <div class="login-container">
                <div class="login-header">
                    <div class="service-icons">
                        <div class="fpt-icon">TaJerMy</div>
                        <div class="arrow">‚Üí</div>
                        <div class="shop-icon">üõçÔ∏è</div>
                    </div>
                    <h2>T√†i kho·∫£n s·ª≠ d·ª•ng d·ªãch v·ª• <span class="fpt-logo">TaJerMy</span></h2>
                </div>
                <div class="login-form">
                    <div id="loginStep1">
                        <label>T√™n ƒëƒÉng nh·∫≠p / S·ªë ƒëi·ªán tho·∫°i <span class="required">*</span></label>
                        <input type="text" id="loginInput" placeholder="Nh·∫≠p t√™n ƒëƒÉng nh·∫≠p ho·∫∑c s·ªë ƒëi·ªán tho·∫°i" class="login-input">
                        <button class="continue-btn" onclick="handleLoginStep1()">Ti·∫øp t·ª•c</button>
                    </div>
                    <div id="loginStep2" style="display: none;">
                        <div class="login-header-step2"><button class="back-btn" onclick="backToStep1()">‚Üê</button> Nh·∫≠p m·∫≠t kh·∫©u</div>
                        <label>M·∫≠t kh·∫©u <span class="required">*</span></label>
                        <input type="password" id="loginPassword" placeholder="Nh·∫≠p m·∫≠t kh·∫©u" class="login-input">
                        <button type="button" class="continue-btn" onclick="handleLoginStep2()">ƒêƒÉng nh·∫≠p</button>
                    </div>
                    <div id="registerStep" style="display: none;">
                        <span onclick="backToLogin()" style="position: absolute; top: 10px; left: 20px; font-size: 30px; font-weight: bold; color: #aaa; cursor: pointer; z-index: 10;">‚Üê</span>
                        <div style="text-align: center; font-weight: bold; font-size: 18px; margin-bottom: 15px; margin-top: -10px;">ƒêƒÉng k√Ω t√†i kho·∫£n</div>
                        <label>T√™n ƒëƒÉng nh·∫≠p <span class="required">*</span></label>
                        <input type="text" id="regUsername" class="login-input" placeholder="Nh·∫≠p t√™n ƒëƒÉng nh·∫≠p" style="margin-bottom: 5px;">
                        <label>S·ªë ƒëi·ªán tho·∫°i <span class="required">*</span></label>
                        <input type="text" id="regPhone" class="login-input" placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i" style="margin-bottom: 5px;">
                        <label>Email <span class="required">*</span></label>
                        <input type="email" id="regGmail" class="login-input" placeholder="Nh·∫≠p email" style="margin-bottom: 5px;">
                        <label>M·∫≠t kh·∫©u <span class="required">*</span></label>
                        <input type="password" id="regPass" class="login-input" placeholder="Nh·∫≠p m·∫≠t kh·∫©u" style="margin-bottom: 5px;">
                        <label>M√£ x√°c nh·∫≠n <span class="required">*</span></label>
                        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                            <input type="text" id="regCode" class="login-input" placeholder="Nh·∫≠p m√£ x√°c nh·∫≠n" style="flex: 1; margin-bottom: 0;">
                            <button type="button" class="continue-btn" onclick="sendVerificationCode()" style="width: auto; margin: 0; padding: 0 15px;">Nh·∫≠n m√£</button>
                        </div>
                        <button class="continue-btn" onclick="handleRegister()">ƒêƒÉng k√Ω</button>
                        <div id="registerMessage" style="text-align: center; margin-top: 2px; font-weight: bold;"></div>
                    </div>
                    <p class="terms-text">
                        B·∫±ng c√°ch ti·∫øp t·ª•c, b·∫°n ƒë·ªìng √Ω v·ªõi 
                        <a href="#" class="link">ƒêi·ªÅu kho·∫£n</a> v√† 
                        <a href="#" class="link">Ch√≠nh s√°ch</a> b·∫£o m·∫≠t c·ªßa TaJerMy
                    </p>
                    <div class="divider">
                        <span>Ho·∫∑c ƒëƒÉng nh·∫≠p b·∫±ng</span>
                    </div>      
                    <div class="social-login">
                        <button class="social-btn apple-btn" onclick="showRegisterForm()">ƒêƒÉng k√Ω</button>
                        <button class="social-btn google-btn">
                            <img src="hinh-anh/google-logo.png" alt="Google" class="google-icon">
                        </button>
                        <button class="social-btn facebook-btn">
                            <img src="hinh-anh/fb-logo.png" alt="Facebook" class="facebook-icon">
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <main>
        <section class="news-hero">
            <div class="container">
                <div class="news-hero-text">
                    <p class="eyebrow">Tin t·ª©c - Ki·∫øn th·ª©c</p>
                    <h1>Video h∆∞·ªõng d·∫´n, ki·∫øn th·ª©c y t·∫ø h·ªØu √≠ch</h1>
                    <p class="sub">Xem nhanh c√°c video ch·ªçn l·ªçc, k√®m b√¨nh lu·∫≠n trao ƒë·ªïi ·ªü m·ªói li√™n k·∫øt.</p>
                </div>
            </div>
        </section>

        <section class="news-list-section">
            <div class="container">
                <div id="newsList" class="news-grid"></div>
                <div id="newsEmpty" class="news-empty" style="display:none;">Ch∆∞a c√≥ video n√†o. Vui l√≤ng quay l·∫°i sau.</div>
            </div>
        </section>
    </main>

    <div id="videoModal" class="video-modal" style="display:none;">
        <div class="video-modal-backdrop" onclick="closeVideoModal()"></div>
        <div class="video-modal-content">
            <button class="video-modal-close" onclick="closeVideoModal()">√ó</button>
            <div class="video-embed" id="videoEmbed"></div>
        </div>
    </div>

    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-column">
                    <h3>H·ªó tr·ª£ kh√°ch h√†ng</h3>
                    <ul>
                        <li>Hotline: 0937 043 808</li>
                        <li>(8-21h k·ªÉ c·∫£ T7, CN)</li>
                        <li>ƒêi·ªÅu kho·∫£n d·ªãch v·ª•</li>
                        <li>Ch√≠nh s√°ch ph·ª•c v·ª•</li>
                        <li>Ch√≠nh s√°ch ƒë·ªïi tr·∫£</li>
                        <li>Ch√≠nh s√°ch b·∫£o m·∫≠t</li>
                        <li>Ch√≠nh s√°ch v·∫≠n chuy·ªÉn</li>
                        <li>Ch√≠nh s√°ch thanh to√°n</li>
                        <li>Ch√≠nh s√°ch b·∫£o h√†nh</li>
                        <li>H·ªó tr·ª£ kh√°ch h√†ng: ducphuongmedical@gmail.com</li>
                    </ul>
                </div>
                
                <div class="footer-column">
                    <h3>B·∫£n tin s·ª©c kh·ªèe</h3>
                    <ul>
                        <li>Tin t·ª©c v·ªÅ gi∆∞·ªùng b·ªánh nh√¢n</li>
                        <li>H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng gi∆∞·ªùng b·ªánh</li>
                        <li>H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng xe lƒÉn ƒëi·ªán</li>
                        <li>Tin t·ª©c v·ªÅ m√°y t·∫°o Oxy</li>
                        <li>Tin t·ª©c v·ªÅ Xe LƒÉn</li>
                    </ul>
                </div>
                
                <div class="footer-column">
                    <h3>Ph∆∞∆°ng th·ª©c thanh to√°n</h3>
                    <div class="payment-methods">
                        <img src="hinh-thanhtoan/visa.png" alt="Visa">
                        <img src="hinh-thanhtoan/mastercard.png" alt="Mastercard">
                        <img src="hinh-thanhtoan/jcb.png" alt="JCB">
                        <img src="hinh-thanhtoan/momo.png" alt="MoMo">
                    </div>
                    
                    <h4>D·ªãch v·ª• giao h√†ng</h4>
                    <div class="delivery-services">
                        <img src="hinh-anh/giao-hang.png" alt="Giao h√†ng">
                    </div>
                </div>
                
                <div class="footer-column">
                    <h3>K·∫øt n·ªëi v·ªõi ch√∫ng t√¥i</h3>
                    <div class="social-links">
                        <a href="https://www.facebook.com/ducphuongnguyenphuoctay" target="_blank">
                            <img src="hinh-anh/fb-logo.png" alt="Facebook">
                        </a>
                        <a href="https://youtube.com/@ducphuongmedical" target="_blank">
                            <img src="hinh-anh/youtube-icon.png" alt="YouTube">
                        </a>
                        <a href="https://zalo.me/0938.062.808" target="_blank">
                            <img src="hinh-anh/icon-zalo.png" alt="Zalo">
                        </a>
                        <a href="https://mail.google.com/mail/?view=cm&fs=1&to=ducphuongmedical@gmail.com" target="_blank">
                            <img src="hinh-anh/icon-gmail.png" alt="Gmail">
                        </a>
                    </div>
                    
                    <div class="certificates">
                        <h4>Ch·ª©ng nh·∫≠n b·ªüi</h4>
                        <div class="cert-logos">
                            <img src="hinh-anh/icon-ddk.png" alt="ƒê√£ ƒëƒÉng k√Ω">
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="footer-bottom">
                <div class="footer-bottom-content">
                    <div class="company-info">
                        <p>ƒê·ªãa ch·ªâ: 12 ƒê√¥ng H·ªì, Ph∆∞·ªùng 08, Qu·∫≠n T√¢n B√¨nh, TP.HCM</p>
                        <p>TaJerMy nh·∫≠n ƒë·∫∑t h√†ng tr·ª±c tuy·∫øn v√† giao h√†ng t·∫≠n n∆°i ho·∫∑c mua h√†ng tr·ª±c ti·∫øp t·∫°i c·ª≠a h√†ng</p>
                        <p>Gi·∫•y ch·ª©ng nh·∫≠n ƒêƒÉng k√Ω Kinh doanh s·ªë 0313717853 do S·ªü K·∫ø ho·∫°ch v√† ƒê·∫ßu t∆∞ Th√†nh ph·ªë H·ªì Ch√≠ Minh c·∫•p ng√†y 25/03/2016</p>
                        <p>&copy; 2022 - B·∫£n quy·ªÅn c·ªßa TaJerMy - www.ducphuongmedical.com. C·∫•m sao ch√©p d∆∞·ªõi m·ªçi h√¨nh th·ª©c n·∫øu kh√¥ng c√≥ s·ª± ch·∫•p thu·∫≠n b·∫±ng vƒÉn b·∫£n.</p>
                    </div>
                </div>
            </div>
        </div>
    </footer>
    <div class="phone-contact">
        <a href="tel:0938062808" data-uid="contact-phone">
            <img src="hinh-anh/icon-dt.png" alt="ƒêi·ªán tho·∫°i">
        </a>
    </div>
    <div class="cskh-contact" onclick="toggleChat()">
        <img src="hinh-anh/icon-cskh.png" alt="CSKH">
    </div>
    <div class="zalo-contact">
        <a href="https://zalo.me/0938.062.808" target="_blank" data-uid="contact-zalo">
            <img src="hinh-anh/icon-zalo.png" alt="Zalo">
        </a>
    </div>
    <div class="youtube-contact">
        <a href="https://www.youtube.com/@ducphuongmedical" target="_blank" data-uid="contact-youtube">
            <img src="hinh-anh/youtube-icon.png" alt="YouTube">
        </a>
    </div>
    <div class="facebook-contact">
        <a href="https://www.facebook.com/ducphuongnguyenphuoctay" target="_blank" data-uid="contact-facebook">
            <img src="hinh-anh/fb-logo.png" alt="Facebook">
        </a>
    </div>

    <script>
    const newsListEl = document.getElementById('newsList');
    const newsEmptyEl = document.getElementById('newsEmpty');
    const videoModal = document.getElementById('videoModal');
    const videoEmbed = document.getElementById('videoEmbed');
    let isLoggedIn = false;

    function extractVideoId(url) {
        if (/^[a-zA-Z0-9_-]{11}$/.test(url)) return url;
        try {
            const u = new URL(url);
            if (u.searchParams.get('v')) return u.searchParams.get('v');
            const pathParts = u.pathname.split('/').filter(Boolean);
            if (u.hostname.includes('youtu.be') && pathParts[0]) return pathParts[0];
            if ((pathParts[0] === 'embed' || pathParts[0] === 'v') && pathParts[1]) return pathParts[1];
        } catch (e) { return null; }
        return null;
    }

    function renderComments(videoId) {
        const wrap = document.querySelector(`[data-comments="${videoId}"]`);
        if (!wrap) return;
        const listEl = wrap.querySelector('.comment-list');
        listEl.innerHTML = '';
        const stored = localStorage.getItem('news_comments_' + videoId);
        const comments = stored ? JSON.parse(stored) : [];
        if (!comments.length) {
            listEl.innerHTML = '<div class="comment-empty">Ch∆∞a c√≥ b√¨nh lu·∫≠n n√†o.</div>';
            return;
        }
        comments.forEach(c => {
            const item = document.createElement('div');
            item.className = 'comment-item';
            item.innerHTML = `<div class="comment-name">${c.name || '·∫®n danh'}</div><div class="comment-text">${c.text}</div><div class="comment-time">${c.time}</div>`;
            listEl.appendChild(item);
        });
    }

    function handleCommentSubmit(videoId, form) {
        const name = form.querySelector('input[name="comment_name"]').value.trim() || '·∫®n danh';
        const text = form.querySelector('textarea[name="comment_text"]').value.trim();
        if (!text) return;
        const key = 'news_comments_' + videoId;
        const existing = localStorage.getItem(key);
        const comments = existing ? JSON.parse(existing) : [];
        comments.unshift({ name, text, time: new Date().toLocaleString('vi-VN') });
        localStorage.setItem(key, JSON.stringify(comments));
        form.reset();
        renderComments(videoId);
    }

    function openVideo(videoId) {
        if (!videoId) return;
        videoEmbed.innerHTML = `<iframe width="100%" height="100%" src="https://www.youtube.com/embed/${videoId}" frameborder="0" allowfullscreen></iframe>`;
        videoModal.style.display = 'flex';
    }

    function closeVideoModal() {
        videoModal.style.display = 'none';
        videoEmbed.innerHTML = '';
    }

    // ===== Account menu (reuse logic t·ª´ trang ch·ªß) =====
    document.addEventListener('DOMContentLoaded', function() {
        // Force clear search box on page load - multiple attempts
        const searchInput = document.querySelector('.search-input');
        if (searchInput) {
            searchInput.value = '';
            setTimeout(() => { searchInput.value = ''; }, 100);
            setTimeout(() => { searchInput.value = ''; }, 500);
        }
        
        checkLoginStatus();
    });

    function checkLoginStatus() {
        fetch('check_session.php', { credentials: 'include' })
            .then(r => r.json())
            .then(data => {
                const accountDropdown = document.querySelector('.account-dropdown');
                const usernameDisplay = document.getElementById('usernameDisplay');
                isLoggedIn = !!data.logged_in;
                if (isLoggedIn) {
                    sessionStorage.setItem('sessionLoggedIn', 'true');
                    if (accountDropdown) accountDropdown.classList.add('logged-in');
                    if (usernameDisplay) {
                        usernameDisplay.innerText = data.username || '';
                        usernameDisplay.style.display = 'block';
                    }
                } else {
                    sessionStorage.removeItem('sessionLoggedIn');
                    if (accountDropdown) accountDropdown.classList.remove('logged-in');
                    if (usernameDisplay) usernameDisplay.style.display = 'none';
                }
            })
            .catch(() => {});
    }

    function handleAccountClick(event) {
        event.stopPropagation();
        const accountMenu = document.getElementById('accountMenu');
        if (!isLoggedIn) {
            // Ch∆∞a ƒëƒÉng nh·∫≠p: m·ªü modal ƒëƒÉng nh·∫≠p tr·ª±c ti·∫øp
            toggleLoginForm();
            return;
        }
        if (accountMenu.style.display === 'block') {
            accountMenu.style.display = 'none';
        } else {
            accountMenu.style.display = 'block';
        }
    }

    document.addEventListener('click', function(event) {
        const accountDropdown = document.querySelector('.account-dropdown');
        const accountMenu = document.getElementById('accountMenu');
        if (accountDropdown && !accountDropdown.contains(event.target)) {
            accountMenu.style.display = 'none';
        }
    });

    // ===== Login modal functions (copy t·ª´ trang ch·ªß) =====
    function handleLoginStep1() {
        const inputVal = document.getElementById('loginInput').value;
        if (!inputVal) {
            alert('Vui l√≤ng nh·∫≠p t√™n ƒëƒÉng nh·∫≠p ho·∫∑c s·ªë ƒëi·ªán tho·∫°i!');
            return;
        }
        document.getElementById('loginStep1').style.display = 'none';
        document.getElementById('loginStep2').style.display = 'block';
    }

    function backToStep1() {
        document.getElementById('loginStep1').style.display = 'block';
        document.getElementById('loginStep2').style.display = 'none';
    }

    function handleLoginStep2() {
        const inputVal = document.getElementById('loginInput').value;
        const password = document.getElementById('loginPassword').value;
        if (!password) {
            alert('Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u!');
            return;
        }
        fetch('login.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ username: inputVal, password: password })
        })
        .then(async response => {
            const raw = await response.text();
            let data;
            try { data = raw ? JSON.parse(raw) : {}; } catch (err) { throw new Error('Ph·∫£n h·ªìi m√°y ch·ªß kh√¥ng h·ª£p l·ªá.'); }
            if (!response.ok || data.status === 'error') {
                throw new Error(data.message || 'ƒêƒÉng nh·∫≠p th·∫•t b·∫°i.');
            }
            return data;
        })
        .then(data => {
            closeLoginForm();
            if (data.position) {
                localStorage.setItem('userPosition', data.position);
            }
            setTimeout(() => {
                if (data.redirect) {
                    if (data.redirect === 'index.html') {
                        window.location.reload();
                    } else {
                        window.location.href = data.redirect;
                    }
                } else {
                    window.location.reload();
                }
            }, 300);
        })
        .catch(error => {
            alert('C√≥ l·ªói x·∫£y ra khi ƒëƒÉng nh·∫≠p: ' + error.message);
        });
    }

    function handleLogout() {
        fetch('logout.php', { credentials: 'include' })
            .then(() => {
                sessionStorage.removeItem('sessionLoggedIn');
                localStorage.removeItem('userPosition');
                window.location.reload();
            });
    }

    function showRegisterForm() {
        document.getElementById('loginStep1').style.display = 'none';
        document.getElementById('loginStep2').style.display = 'none';
        document.querySelector('.terms-text').style.display = 'none';
        document.querySelector('.divider').style.display = 'none';
        document.querySelector('.social-login').style.display = 'none';
        document.getElementById('registerStep').style.display = 'block';
        document.getElementById('registerMessage').innerText = '';
        document.getElementById('regUsername').value = '';
        document.getElementById('regPhone').value = '';
        document.getElementById('regGmail').value = '';
        document.getElementById('regPass').value = '';
        if(document.getElementById('regCode')) document.getElementById('regCode').value = '';
    }

    function backToLogin() {
        document.getElementById('registerStep').style.display = 'none';
        document.getElementById('loginStep1').style.display = 'block';
        document.querySelector('.terms-text').style.display = 'block';
        document.querySelector('.divider').style.display = 'block';
        document.querySelector('.social-login').style.display = 'flex';
    }

    function sendVerificationCode() {
        const gmail = document.getElementById('regGmail').value;
        if (!gmail) {
            alert('Vui l√≤ng nh·∫≠p email ƒë·ªÉ nh·∫≠n m√£!');
            return;
        }
        const formData = new FormData();
        formData.append('send', 'true');
        formData.append('gmail', gmail);
        fetch('/xacnhangamil.php', { method: 'POST', body: formData })
            .then(response => response.text())
            .then(data => { alert(data); })
            .catch(() => { alert('C√≥ l·ªói x·∫£y ra khi g·ª≠i m√£.'); });
    }

    function handleRegister() {
        const user = document.getElementById('regUsername').value;
        const phone = document.getElementById('regPhone').value;
        const gmail = document.getElementById('regGmail').value;
        const pass = document.getElementById('regPass').value;
        const code = document.getElementById('regCode').value;
        const msgDiv = document.getElementById('registerMessage');
        if (!user || !phone || !gmail || !pass || !code) {
            msgDiv.style.color = 'red';
            msgDiv.innerText = 'Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin v√† m√£ x√°c nh·∫≠n!';
            return;
        }
        const formData = new FormData();
        formData.append('code', code);
        fetch('/check_code.php', { method: 'POST', body: formData })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    fetch('/register.php', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username: user, phone: phone, gmail: gmail, password: pass })
                    })
                    .then(response => response.text())
                    .then(text => {
                        let regData;
                        try { regData = JSON.parse(text); } catch (e) { regData = { status: 'error', message: text || 'C√≥ l·ªói x·∫£y ra, vui l√≤ng th·ª≠ l·∫°i.' }; }
                        if (regData.status === 'success') {
                            msgDiv.style.color = '#4CAF50';
                            msgDiv.innerText = 'ƒêƒÉng k√Ω th√†nh c√¥ng!';
                        } else {
                            msgDiv.style.color = 'red';
                            msgDiv.innerText = regData.message || 'C√≥ l·ªói x·∫£y ra, vui l√≤ng th·ª≠ l·∫°i.';
                        }
                    })
                    .catch(() => {
                        msgDiv.style.color = 'red';
                        msgDiv.innerText = 'C√≥ l·ªói x·∫£y ra, vui l√≤ng th·ª≠ l·∫°i.';
                    });
                } else {
                    msgDiv.style.color = 'red';
                    msgDiv.innerText = 'Sai m√£ x√°c nh·∫≠n';
                }
            })
            .catch(() => {
                msgDiv.style.color = 'red';
                msgDiv.innerText = 'L·ªói ki·ªÉm tra m√£ x√°c nh·∫≠n.';
            });
    }

    function toggleLoginForm() {
        document.getElementById('loginModal').style.display = 'block';
        if (typeof backToLogin === 'function') backToLogin();
        if (typeof backToStep1 === 'function') backToStep1();
        if(document.getElementById('loginInput')) document.getElementById('loginInput').value = '';
        if(document.getElementById('loginPassword')) document.getElementById('loginPassword').value = '';
    }
    function closeLoginForm() { document.getElementById('loginModal').style.display = 'none'; }
    window.onclick = function(event) {
        var modal = document.getElementById('loginModal');
        if (event.target == modal) {
            modal.style.display = 'none';
        }
    }

    function renderNews(items) {
        console.log('renderNews ƒë∆∞·ª£c g·ªçi v·ªõi', items.length, 'item(s)');
        newsListEl.innerHTML = '';
        if (!items.length) {
            newsEmptyEl.style.display = 'block';
            return;
        }
        newsEmptyEl.style.display = 'none';
        items.forEach((item, index) => {
            console.log(`ƒêang render item ${index + 1}:`, item.title);
            const videoId = item.video_id || extractVideoId(item.youtube_url);
            
            // Escape HTML v√† x·ª≠ l√Ω xu·ªëng d√≤ng trong note
            const safeTitle = (item.title || '').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            const safeNote = (item.note || '').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\r\n/g, '<br>').replace(/\n/g, '<br>');
            const safeCreatedBy = (item.created_by || 'Admin').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            
            const card = document.createElement('div');
            card.className = 'news-card';
            card.innerHTML = `
                <div class="news-thumb">
                    <img src="${item.thumbnail || ('https://img.youtube.com/vi/' + videoId + '/hqdefault.jpg')}" alt="${safeTitle}">
                    <button class="play-overlay" aria-label="Xem video">‚ñ∂</button>
                </div>
                <div class="news-body">
                    <h3>${safeTitle}</h3>
                    <div>
                        <p class="news-note" data-video-id="${videoId}">${safeNote}</p>
                        <span class="news-note-toggle" data-video-id="${videoId}">Xem th√™m</span>
                    </div>
                    <div class="news-meta">ƒêƒÉng b·ªüi ${safeCreatedBy} ‚Ä¢ ${new Date(item.created_at || Date.now()).toLocaleDateString('vi-VN')}</div>
                    <div class="news-actions">
                        <button class="primary-btn" data-watch="${videoId}">Xem nhanh</button>
                        <a class="secondary-btn" href="https://www.youtube.com/watch?v=${videoId}" target="_blank" rel="noopener">M·ªü tr√™n YouTube</a>
                    </div>
                </div>
                <div class="news-comments" data-comments="${videoId}">
                    <h4>B√¨nh lu·∫≠n</h4>
                    <div class="comment-list"></div>
                    <form class="comment-form">
                        <input type="text" name="comment_name" placeholder="T√™n c·ªßa b·∫°n (tu·ª≥ ch·ªçn)">
                        <textarea name="comment_text" rows="2" placeholder="Nh·∫≠p b√¨nh lu·∫≠n..."></textarea>
                        <button type="submit">G·ª≠i</button>
                    </form>
                </div>
            `;
            card.querySelector('.play-overlay').addEventListener('click', () => openVideo(videoId));
            card.querySelector('[data-watch]').addEventListener('click', () => openVideo(videoId));
            
            // Toggle note expand/collapse
            const noteToggle = card.querySelector('.news-note-toggle');
            const noteEl = card.querySelector('.news-note');
            if (noteToggle && noteEl) {
                noteToggle.addEventListener('click', () => {
                    if (noteEl.classList.contains('expanded')) {
                        noteEl.classList.remove('expanded');
                        noteToggle.textContent = 'Xem th√™m';
                    } else {
                        noteEl.classList.add('expanded');
                        noteToggle.textContent = 'Thu g·ªçn';
                    }
                });
            }
            
            const form = card.querySelector('.comment-form');
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                handleCommentSubmit(videoId, form);
            });
            newsListEl.appendChild(card);
            console.log(`Card ${index + 1} ƒë√£ ƒë∆∞·ª£c th√™m v√†o DOM`);
            renderComments(videoId);
        });
        console.log('Ho√†n t·∫•t render t·∫•t c·∫£ cards');
    }

    async function loadNews() {
        try {
            console.log('ƒêang t·∫£i tin t·ª©c...');
            const res = await fetch('api/news_list.php');
            console.log('Response status:', res.status);
            const data = await res.json();
            console.log('D·ªØ li·ªáu nh·∫≠n ƒë∆∞·ª£c:', data);
            if (data.success) {
                console.log('S·ªë l∆∞·ª£ng tin t·ª©c:', data.items?.length || 0);
                renderNews(data.items || []);
            } else {
                console.error('API tr·∫£ v·ªÅ l·ªói:', data.error);
                newsEmptyEl.style.display = 'block';
                newsEmptyEl.textContent = 'Kh√¥ng t·∫£i ƒë∆∞·ª£c tin t·ª©c.';
            }
        } catch (err) {
            console.error('L·ªói khi t·∫£i tin t·ª©c:', err);
            newsEmptyEl.style.display = 'block';
            newsEmptyEl.textContent = 'Kh√¥ng t·∫£i ƒë∆∞·ª£c tin t·ª©c. L·ªói: ' + err.message;
        }
    }

    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') closeVideoModal();
    });

    loadNews();
    </script>
    <script src="search-suggestions.js"></script>
</body>
</html>
