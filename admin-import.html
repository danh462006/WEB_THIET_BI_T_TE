<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Import CSV Sản Phẩm</title>
  <link rel="icon" type="image/png" href="hinh-anh/logo-favicon.png">
  <link rel="stylesheet" href="style.css">
  <style>
    body { background:#f6f7fb; color:#111827; }
    .container { max-width: 800px; margin: 40px auto; background:#fff; border:1px solid #e5e7eb; border-radius:8px; padding:16px; }
    .header { font-weight:700; margin-bottom:12px; }
    .row { display:flex; gap:12px; align-items:center; margin:10px 0; }
    .btn { padding:10px 14px; font-weight:700; border:none; border-radius:6px; cursor:pointer; }
    .btn-primary { background:#0d6efd; color:#fff; }
    .btn-secondary { background:#6b7280; color:#fff; }
    .result { background:#f9fafb; border:1px solid #e5e7eb; padding:12px; border-radius:6px; margin-top:12px; white-space:pre-wrap; }
    .help { color:#6b7280; font-size:13px; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">Import CSV Sản Phẩm</div>
    <div class="help">
      File CSV cần có cột: id, tên các cột muốn cập nhật (name, sku, short_description, long_description, technical_specs, brand, weight, dimensions, slug, meta_title, meta_description, meta_keywords, thumbnail_path, gallery_paths, ...).<br>
      Server sẽ tự động loại bỏ HTML/CSS/script và chuẩn hóa slug.
    </div>
    <form id="importForm">
      <div class="row">
        <input type="file" name="file" id="fileInput" accept=".csv" required />
        <label><input type="checkbox" name="dry_run" id="dryRun" value="1" /> Dry run (chỉ xem trước)</label>
      </div>
      <div class="row">
        <button type="submit" class="btn btn-primary">Import</button>
        <button type="button" class="btn btn-secondary" onclick="document.getElementById('importForm').reset()">Reset</button>
      </div>
    </form>
    <div id="result" class="result"></div>

    <div class="help" style="margin-top:12px;">
      Mẹo: Nếu Excel chứa nhiều HTML phức tạp, bạn có thể chạy script làm sạch trước khi import:<br>
      php tools/clean_csv.php input.csv output.csv
    </div>
  </div>

<script>
  document.getElementById('importForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const fd = new FormData(e.target);
    const res = await fetch('/api/admin_import_products.php', { method: 'POST', body: fd });
    const out = await res.json();
    document.getElementById('result').textContent = JSON.stringify(out, null, 2);
  });

  // ========== QUICK PRODUCT LIST (VIEW-ONLY) ==========
  async function loadQuickList() {
    const container = document.querySelector('.container');
    let section = document.getElementById('quickListSection');
    if (!section) {
      section = document.createElement('div');
      section.id = 'quickListSection';
      section.innerHTML = `
        <hr style="margin: 24px 0; border: none; border-top: 1px solid #e5e7eb;"/>
        <div class="header">Danh sách sản phẩm (xem nhanh)</div>
        <div class="row">
          <input type="text" id="qSearch" placeholder="Tìm theo tên hoặc SKU..." style="flex:1; padding:10px 12px; border:1px solid #e5e7eb; border-radius:6px;" />
          <label><input type="checkbox" id="qMissing"> Thiếu thông tin</label>
          <label><input type="checkbox" id="qNoImage"> Chưa có ảnh</label>
          <button class="btn btn-primary" id="qReload">Tải danh sách</button>
        </div>
        <table id="quickTable" style="width:100%; border-collapse:collapse; background:#fff; border:1px solid #e5e7eb; border-radius:8px; overflow:hidden;">
          <thead>
            <tr style="background:#f9fafb;">
              <th style="padding:10px 12px; text-align:left;">ID</th>
              <th style="padding:10px 12px; text-align:left;">Tên</th>
              <th style="padding:10px 12px; text-align:left;">SKU</th>
              <th style="padding:10px 12px; text-align:left;">Giá</th>
              <th style="padding:10px 12px; text-align:left;">Trạng thái</th>
              <th style="padding:10px 12px; text-align:left;">Hoàn thiện</th>
              <th style="padding:10px 12px; text-align:left;">Hành động</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      `;
      container.appendChild(section);
      document.getElementById('qReload').addEventListener('click', renderQuickList);
    }
    await renderQuickList();
  }

  async function renderQuickList() {
    const search = (document.getElementById('qSearch')?.value || '').trim();
    const missingOnly = document.getElementById('qMissing')?.checked ? '1' : '0';
    const noImageOnly = document.getElementById('qNoImage')?.checked ? '1' : '0';
    const qs = new URLSearchParams({ search, missing_only: missingOnly, no_image_only: noImageOnly });
    const res = await fetch('api/admin_product_list.php?' + qs.toString());
    const out = await res.json();
    const tbody = document.querySelector('#quickTable tbody');
    tbody.innerHTML = '';
    if (!out.success) {
      tbody.innerHTML = '<tr><td colspan="7" style="padding:10px 12px;">Không tải được danh sách</td></tr>';
      return;
    }
    for (const p of out.data) {
      const tr = document.createElement('tr');
      const price = p.sale_price || p.original_price || 0;
      const badge = p.is_complete
        ? '<span style="background:#dcfce7; color:#166534; padding:4px 8px; border-radius:999px; font-weight:700; font-size:12px;">✅ Đã đầy đủ</span>'
        : '<span style="background:#fef3c7; color:#92400e; padding:4px 8px; border-radius:999px; font-weight:700; font-size:12px;">⚠️ Thiếu thông tin</span>';
      tr.innerHTML = `
        <td style="padding:10px 12px;">${p.id}</td>
        <td style="padding:10px 12px;">${p.name}</td>
        <td style="padding:10px 12px;">${p.sku || ''}</td>
        <td style="padding:10px 12px;">${price.toLocaleString('vi-VN')}</td>
        <td style="padding:10px 12px;">${p.status || ''}</td>
        <td style="padding:10px 12px;">${badge}</td>
        <td style="padding:10px 12px;">
          <a class="btn btn-secondary" href="quan-tri-vien-sanpham.php?id=${p.id}">Chi tiết</a>
        </td>
      `;
      tbody.appendChild(tr);
    }
  }

  document.addEventListener('DOMContentLoaded', loadQuickList);
</script>
</body>
</html>
