<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n Tr·ªã Vi√™n - TBYT ƒê·ª©c Ph∆∞∆°ng</title>
    <link rel="icon" type="image/png" href="hinh-anh/logo-favicon.png">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="category-style.css">
    <link rel="stylesheet" href="mobile-responsive.css">
    <script src="auth-redirect.js"></script>
    <style>
        @keyframes fadeInDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .modal-content {
            animation: fadeInDown 0.4s ease-out;
        }

        /* CSS cho giao di·ªán Qu·∫£n tr·ªã vi√™n */
        .admin-edit-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background-color: #ffc107;
            color: #000;
            border: 1px solid #d39e00;
            border-radius: 4px;
            padding: 2px 6px;
            font-size: 11px;
            font-weight: bold;
            cursor: pointer;
            margin-left: 8px;
            z-index: 9999;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: all 0.2s;
            text-decoration: none !important;
            white-space: nowrap;
        }
        .admin-edit-btn:hover {
            background-color: #e0a800;
            transform: scale(1.05);
        }
        
        /* Style cho n√∫t s·ª≠a ·∫£nh (n·∫±m ƒë√® l√™n ·∫£nh) */
        .admin-edit-btn-img {
            position: absolute;
            top: 10px;
            right: 10px;
            opacity: 0.8;
        }
        .admin-edit-btn-img:hover {
            opacity: 1;
        }

        /* Overlay khi kh√¥ng c√≥ quy·ªÅn truy c·∫≠p */
        #accessDeniedOverlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: white;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        /* CSS cho modal ch·ªânh s·ª≠a ·∫£nh */
        .image-edit-modal-content {
            padding: 20px 30px;
            text-align: left;
        }
        .image-edit-modal-content h2 {
            text-align: center;
            margin-top: 0;
            margin-bottom: 20px;
            font-size: 20px;
        }
        .image-edit-modal-content label {
            display: block;
            margin-top: 15px;
            margin-bottom: 5px;
            font-weight: 500;
        }
        .image-edit-modal-content input[type="file"],
        .image-edit-modal-content input[type="text"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .progress-bar-container {
            width: 100%;
            background-color: #e9ecef;
            border-radius: 5px;
            margin-top: 20px;
            overflow: hidden;
            display: none; /* ·∫®n ban ƒë·∫ßu */
        }
        .progress-bar {
            width: 0%;
            height: 24px;
            background-color: #4CAF50;
            text-align: center;
            line-height: 24px;
            color: white;
            font-weight: bold;
            border-radius: 5px;
            transition: width 0.3s ease-in-out;
        }
        #updateImageBtn {
            margin-top: 15px;
            background-color: #28a745; /* M√†u xanh l√° c√¢y ƒë·∫≠m h∆°n */
        }
        /* Textarea trong modal s·ª≠a vƒÉn b·∫£n */
        #textEditInput {
            min-height: 100px;
            resize: vertical;
        }
        /* Path preview styling */
        #pathPreview {
            font-size: 13px;
            word-break: break-all;
        }
        #pathPreviewText {
            color: #0066cc;
            font-family: monospace;
        }
        #customFolderDiv {
            margin-top: 10px;
        }

        /* Profile Modal Styles */
        .profile-modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            overflow: auto;
        }

        .profile-modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            position: relative;
        }

        .profile-modal-small {
            max-width: 450px;
        }

        .profile-close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 20px;
        }

        .profile-close:hover,
        .profile-close:focus {
            color: #000;
        }

        .profile-avatar-section {
            text-align: center;
            margin-bottom: 30px;
        }

        .profile-avatar-img {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #4CAF50;
            margin-bottom: 15px;
        }

        .profile-info-section {
            margin-top: 20px;
        }

        .profile-field {
            margin-bottom: 20px;
        }

        .profile-field label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
            color: #333;
        }

        .profile-input,
        .profile-textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            box-sizing: border-box;
        }

        .profile-input:read-only {
            background-color: #f5f5f5;
        }

        .profile-textarea {
            resize: vertical;
            font-family: inherit;
        }

        .profile-btn-primary {
            background-color: #4CAF50;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            margin-top: 10px;
        }

        .profile-btn-primary:hover {
            background-color: #45a049;
        }

        .profile-btn-secondary {
            background-color: #2196F3;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }

        .profile-btn-secondary:hover {
            background-color: #0b7dda;
        }

        .profile-btn-change {
            background-color: #ff9800;
            color: white;
            padding: 6px 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            margin-left: 10px;
        }

        .profile-btn-change:hover {
            background-color: #e68900;
        }

        .profile-btn-edit {
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 18px;
            margin-left: 10px;
        }

        .profile-link-change {
            display: block;
            color: #2196F3;
            text-decoration: none;
            font-size: 14px;
            margin-top: 5px;
        }

        .profile-link-change:hover {
            text-decoration: underline;
        }

        @media (max-width: 768px) {
            .profile-modal-content {
                width: 95%;
                padding: 20px;
                margin: 10% auto;
            }

            .profile-avatar-img {
                width: 100px;
                height: 100px;
            }
        }
    </style>
</head>
<body>
    <!-- Overlay ki·ªÉm tra quy·ªÅn (M·∫∑c ƒë·ªãnh ·∫©n, hi·ªán l√™n n·∫øu check th·∫•t b·∫°i) -->
    <div id="accessDeniedOverlay" style="display: none;">
        <h1 style="color: red;">Truy c·∫≠p b·ªã t·ª´ ch·ªëi</h1>
        <p>B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p trang qu·∫£n tr·ªã n√†y.</p>
        <button onclick="window.location.href='index.html'" style="padding: 10px 20px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer; margin-top: 20px;">V·ªÅ trang ch·ªß</button>
        <button onclick="toggleLoginForm(); document.getElementById('accessDeniedOverlay').style.display='none';" style="padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; margin-top: 10px;">ƒêƒÉng nh·∫≠p l·∫°i</button>
    </div>

    <!-- Profile Modal -->
    <div id="profileModal" class="profile-modal" style="display: none;">
        <div class="profile-modal-content">
            <span class="profile-close" onclick="closeProfileModal()">&times;</span>
            <h2>Th√¥ng tin t√†i kho·∫£n</h2>
            
            <!-- Avatar Section -->
            <div class="profile-avatar-section">
                <img id="profileAvatar" src="hinh-anh/hinh-tk-macdinh.png" alt="Avatar" class="profile-avatar-img">
                <input type="file" id="avatarInput" accept="image/*" style="display: none;" onchange="handleAvatarUpload(event)">
                <button class="profile-btn-secondary" onclick="document.getElementById('avatarInput').click()">Ch·ªânh s·ª≠a avatar</button>
            </div>

            <!-- User Info Section -->
            <div class="profile-info-section">
                <div class="profile-field">
                    <label>T√™n ng∆∞·ªùi d√πng:</label>
                    <input type="text" id="profileUsername" class="profile-input" readonly>
                    <button class="profile-btn-edit" onclick="enableEdit('profileUsername')">‚úèÔ∏è</button>
                </div>

                <div class="profile-field">
                    <label>S·ªë ƒëi·ªán tho·∫°i:</label>
                    <input type="text" id="profilePhone" class="profile-input" readonly>
                    <button class="profile-btn-change" onclick="openChangePhoneModal()">Thay ƒë·ªïi</button>
                </div>

                <div class="profile-field">
                    <label>Email:</label>
                    <input type="email" id="profileEmail" class="profile-input" readonly>
                    <button class="profile-btn-change" onclick="openChangeEmailModal()">Thay ƒë·ªïi</button>
                </div>

                <div class="profile-field">
                    <label>M·∫≠t kh·∫©u:</label>
                    <div style="position: relative;">
                        <input type="password" id="profilePassword" class="profile-input" value="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" readonly>
                        <span onclick="togglePasswordVisibility()" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); cursor: pointer; font-size: 20px;">üëÅÔ∏è</span>
                    </div>
                    <a href="#" class="profile-link-change" onclick="openChangePasswordModal(); return false;">Thay ƒë·ªïi m·∫≠t kh·∫©u</a>
                </div>

                <div class="profile-field">
                    <label>ƒê·ªãa ch·ªâ:</label>
                    <textarea id="profileAddress" class="profile-textarea" rows="3"></textarea>
                </div>

                <button class="profile-btn-primary" onclick="saveProfileChanges()">L∆∞u thay ƒë·ªïi</button>
            </div>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div id="changePasswordModal" class="profile-modal" style="display: none;">
        <div class="profile-modal-content profile-modal-small">
            <span class="profile-close" onclick="closeChangePasswordModal()">&times;</span>
            <h3>Thay ƒë·ªïi m·∫≠t kh·∫©u</h3>
            
            <div class="profile-field">
                <label>M·∫≠t kh·∫©u c≈©:</label>
                <input type="password" id="oldPassword" class="profile-input">
            </div>

            <div class="profile-field">
                <label>M·∫≠t kh·∫©u m·ªõi:</label>
                <input type="password" id="newPassword" class="profile-input">
            </div>

            <div class="profile-field">
                <label>M√£ x√°c nh·∫≠n:</label>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="passwordVerifyCode" class="profile-input" style="flex: 1;">
                    <button class="profile-btn-secondary" onclick="sendPasswordVerificationCode()">G·ª≠i m√£</button>
                </div>
                <small style="color: #666;">M√£ x√°c nh·∫≠n s·∫Ω ƒë∆∞·ª£c g·ª≠i ƒë·∫øn email c·ªßa b·∫°n</small>
            </div>

            <button class="profile-btn-primary" onclick="updatePassword()">C·∫≠p nh·∫≠t m·∫≠t kh·∫©u</button>
        </div>
    </div>

    <!-- Change Phone Modal -->
    <div id="changePhoneModal" class="profile-modal" style="display: none;">
        <div class="profile-modal-content profile-modal-small">
            <span class="profile-close" onclick="closeChangePhoneModal()">&times;</span>
            <h3>Thay ƒë·ªïi s·ªë ƒëi·ªán tho·∫°i</h3>
            
            <div class="profile-field">
                <label>S·ªë ƒëi·ªán tho·∫°i m·ªõi:</label>
                <input type="text" id="newPhone" class="profile-input">
            </div>

            <div class="profile-field">
                <label>M√£ x√°c nh·∫≠n:</label>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="phoneVerifyCode" class="profile-input" style="flex: 1;">
                    <button class="profile-btn-secondary" onclick="sendPhoneVerificationCode()">G·ª≠i m√£</button>
                </div>
                <small style="color: #666;">M√£ x√°c nh·∫≠n s·∫Ω ƒë∆∞·ª£c g·ª≠i ƒë·∫øn SƒêT m·ªõi</small>
            </div>

            <button class="profile-btn-primary" onclick="updatePhone()">C·∫≠p nh·∫≠t SƒêT</button>
        </div>
    </div>

    <!-- Change Email Modal -->
    <div id="changeEmailModal" class="profile-modal" style="display: none;">
        <div class="profile-modal-content profile-modal-small">
            <span class="profile-close" onclick="closeChangeEmailModal()">&times;</span>
            <h3>Thay ƒë·ªïi Email</h3>
            
            <div class="profile-field">
                <label>Email m·ªõi:</label>
                <input type="email" id="newEmail" class="profile-input">
            </div>

            <div class="profile-field">
                <label>M√£ x√°c nh·∫≠n:</label>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="emailVerifyCode" class="profile-input" style="flex: 1;">
                    <button class="profile-btn-secondary" onclick="sendEmailVerificationCode()">G·ª≠i m√£</button>
                </div>
                <small style="color: #666;">M√£ x√°c nh·∫≠n s·∫Ω ƒë∆∞·ª£c g·ª≠i ƒë·∫øn email m·ªõi</small>
            </div>

            <button class="profile-btn-primary" onclick="updateEmail()">C·∫≠p nh·∫≠t Email</button>
        </div>
    </div>

    <header class="header">
        <div class="container">
            <div class="logo-section">
                <img src="hinh-anh/logo.png" alt="TBYT ƒê·ª©c Ph∆∞∆°ng" class="logo">
            </div>
            
            <div class="search-section">
                <div class="search-box">
                    <input type="text" placeholder="T√¨m Ki·∫øm ..." class="search-input" autocomplete="off">
                    <button class="search-btn">üîç</button>
                </div>
                <div class="search-suggestions" id="searchSuggestions"></div>
            </div>
            
            <div class="user-section">
                <div class="account-dropdown">
                    <button class="account-btn" onclick="handleAccountClick(event)">
                        <img src="hinh-anh/icon_tk.png" alt="T√†i kho·∫£n" class="account-icon">
                    </button>
                    <div id="usernameDisplay" class="username-display" style="display: none;"></div>
                    <div class="account-menu" id="accountMenu" style="min-width: 150px; right: 0; left: auto;">
                        <a href="#" onclick="event.stopPropagation(); openProfileModal(); return false;">Th√¥ng tin t√†i kho·∫£n</a>
                        <a href="#">ƒê∆°n h√†ng c·ªßa t√¥i</a>
                        <a href="#" onclick="handleLogout(); return false;">ƒêƒÉng xu·∫•t</a>
                    </div>
                </div>
                <button class="cart-btn">üõí Gi·ªè h√†ng</button>
                <div class="dropdown">
                    <button class="dropdown-btn">üìã Danh m·ª•c ‚ñº</button>
                    <div class="dropdown-content">
                        <a href="index.html">Trang ch·ªß</a>
                        <div class="dropdown-item-with-submenu">
                            <a href="#" class="has-submenu">S·∫£n ph·∫©m</a>
                            <div class="submenu">
                                <div class="submenu-content">
                                    <div class="category-header">
                                        <h3>üî• G·ª£i √Ω cho b·∫°n</h3>
                                    </div>
                                    
                                    <div class="category-brands">
                                        <div class="brand-item" data-category="Gi∆∞·ªùng"><img src="icon-hinhdanhmuc/nhom-giuong.png" alt="Gi∆∞·ªùng" class="category-icon">Gi∆∞·ªùng</div>
                                        <div class="brand-item" data-category="Xe lƒÉn"><img src="icon-hinhdanhmuc/nhom-xelan.png" alt="Xe lƒÉn" class="category-icon">Xe lƒÉn</div>
                                        <div class="brand-item" data-category="Xe Scooter ƒëi·ªán"><img src="icon-hinhdanhmuc/nhom-xedien.png" alt="Xe Scooter ƒëi·ªán" class="category-icon">Xe Scooter ƒëi·ªán</div>
                                        <div class="brand-item" data-category="BƒÉng ca"><img src="icon-hinhdanhmuc/nhom-bangca.png" alt="BƒÉng ca" class="category-icon">BƒÉng ca</div>
                                        <div class="brand-item" data-category="T·ªß"><img src="icon-hinhdanhmuc/nhom-tu.png" alt="T·ªß" class="category-icon">T·ªß</div>
                                        <div class="brand-item" data-category="M√°y t·∫°o oxy"><img src="icon-hinhdanhmuc/nhom-maytaooxy.png" alt="M√°y t·∫°o oxy" class="category-icon">M√°y t·∫°o oxy</div>
                                        <div class="brand-item" data-category="M√°y ƒëo"><img src="icon-hinhdanhmuc/nhom-maydo.png" alt="M√°y ƒëo" class="category-icon">M√°y ƒëo</div>
                                        <div class="brand-item" data-category="M√°y x√¥ng"><img src="icon-hinhdanhmuc/nhom-xong.png" alt="M√°y x√¥ng" class="category-icon">M√°y x√¥ng</div>
                                        <div class="brand-item" data-category="M√°y h√∫t d·ªãch"><img src="icon-hinhdanhmuc/nhom-mayhutdich.png" alt="M√°y h√∫t d·ªãch" class="category-icon">M√°y h√∫t d·ªãch</div>
                                        <div class="brand-item" data-category="M√°y massage"><img src="icon-hinhdanhmuc/nhom-massage.png" alt="M√°y massage" class="category-icon">M√°y massage</div>
                                        <div class="brand-item" data-category="Thi·∫øt b·ªã t·∫≠p"><img src="icon-hinhdanhmuc/nhom-maytap.png" alt="Thi·∫øt b·ªã t·∫≠p" class="category-icon">Thi·∫øt b·ªã t·∫≠p</div>
                                        <div class="brand-item" data-category="N·ªám"><img src="icon-hinhdanhmuc/nhom-nem.png" alt="N·ªám" class="category-icon">N·ªám</div>
                                        <div class="brand-item" data-category="D·ª•ng c·ª• h·ªó tr·ª£"><img src="icon-hinhdanhmuc/nhom-dungcuhotro.png" alt="D·ª•ng c·ª• h·ªó tr·ª£" class="category-icon">D·ª•ng c·ª• h·ªó tr·ª£</div>
                                        <div class="brand-item" data-category="Thi·∫øt b·ªã y t·∫ø kh√°c"><img src="icon-hinhdanhmuc/nhom-thietbiyte.png" alt="Thi·∫øt b·ªã y t·∫ø kh√°c" class="category-icon">Thi·∫øt b·ªã y t·∫ø kh√°c</div>
                                    </div>

                                    <div class="category-main">
                                        <div class="category-detail" id="categoryDetail">
                                            <p>Di chu·ªôt v√†o c√°c nh√≥m s·∫£n ph·∫©m ·ªü tr√™n ƒë·ªÉ xem chi ti·∫øt</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <a href="quan-tri-vien-thongtin.html">Gi·ªõi thi·ªáu</a>
                        <a href="tin-tuc.html">Tin t·ª©c - Ki·∫øn th·ª©c</a>
                    </div>
                </div>
            </div>
        </div>
    </header>
    
    <main>
        <section class="intro-section reveal">
            <div class="container">
                <img src="hinh-anh/anh-trangchu.png" alt="Gi·ªõi thi·ªáu ƒê·ª©c Ph∆∞∆°ng Medical" class="intro-image">
            </div>
        </section>
    
    <section class="slideshow-section reveal">
        <div class="container">
            <div class="slideshow-layout">
                <div class="info-columns">
                    <div class="info-item">
                        <div class="info-icon">
                            <div class="icon-circle">
                                <span>üëÅ</span>
                            </div>
                        </div>
                        <h3>T·∫¶M NH√åN</h3>
                        <p>ƒê·ª©c Ph∆∞∆°ng h∆∞·ªõng t·ªõi tr·ªü th√†nh ƒë∆°n v·ªã ph√¢n ph·ªëi thi·∫øt b·ªã y t·∫ø h√†ng ƒë·∫ßu Vi·ªát Nam g√≥p ph·∫ßn n√¢ng cao ch·∫•t l∆∞·ª£ng chƒÉm s√≥c s·ª©c kh·ªèe trong n∆∞·ªõc v√† mang l·∫°i nh·ªØng gi·∫£i ph√°p chƒÉm s√≥c to√†n di·ªán cho m·ªçi gia ƒë√¨nh.</p>
                    </div>
                    <div class="info-item">
                        <div class="info-icon">
                            <div class="icon-circle">
                                <span>üéØ</span>
                            </div>
                        </div>
                        <h3>S·ª® M·ªÜNH</h3>
                        <p>- Cung c·∫•p s·∫£n ph·∫©m ch·∫•t l∆∞·ª£ng - an to√†n - b·ªÅn v·ªØng cho m·ªçi ng∆∞·ªùi d√πng<br>
                        - ƒêem l·∫°i nh·ªØng cao c·∫•p th√¥ng qua s·ª©c b·ªÅn v√† ƒë·ªô b·ªÅn c·ªßa s·∫£n ph·∫©m<br>
                        - T∆∞ v·∫•n chuy√™n nghi·ªáp ng√†y ƒë√™m b√°c sƒ©, b·ªánh nh√¢n v√† c·ªông ƒë·ªìng trong vi·ªác tr√¨nh chƒÉm s√≥c s·ª©c kh·ªèe b·ªÅn v·ªØng</p>
                    </div>
                    <div class="info-item">
                        <div class="info-icon">
                            <div class="icon-circle">
                                <span>üèÜ</span>
                            </div>
                        </div>
                        <h3>GI√Å TR·ªä C·ªêT L√ïI</h3>
                        <p>ƒê·ª©c Ph∆∞∆°ng cam k·∫øt lu√¥n ƒë·∫∑t l·ª£i √≠ch c·ªßa kh√°ch h√†ng l√™n h√†ng ƒë·∫ßu. Ch√∫ng t√¥i kh√¥ng ng·ª´ng n·ªó l·ª±c ƒëem ƒë·∫øn s·ª± m·ªü r·ªông s·∫£n ph·∫©m v√† n√¢ng cao ch·∫•t l∆∞·ª£ng d·ªãch v·ª• t∆∞ v·∫•n, h·ªó tr·ª£ kh√°ch h√†ng l√≤ng v√† tin t∆∞·ªüng c·ªßa Qu√Ω kh√°ch h√†ng ch√≠nh l√† ƒë·ªông l·ª±c l·ªõn nh·∫•t ƒë·ªÉ ƒê·ª©c Ph∆∞∆°ng ti·∫øp t·ª•c ph√°t tri·ªÉn.</p>
                    </div>
                </div>
                <div class="partners-wrapper">
                    <div class="partners-layout">
                        <div class="partners-left">
                            <h2>ƒê·ªêI T√ÅC C·ª¶A CH√öNG T√îI</h2>
                            <img src="hinh-chung-nhan/hinh-doitac.png" alt="ƒê·ªëi t√°c c·ªßa ch√∫ng t√¥i" onclick="openCertModal('hinh-chung-nhan/hinh-doitac.png', 'ƒê·ªëi t√°c c·ªßa ch√∫ng t√¥i')" style="cursor: pointer;">
                        </div>
                        <div class="partners-right">
                            <h2>NƒÇNG L·ª∞C ƒê·ªêI T√ÅC</h2>
                            <div class="certificate-carousel">
                                <div class="certificate-wrapper">
                                    <div class="certificate-track" id="certificateTrack">
                                        <div class="certificate-item" onclick="openCertModal('hinh-chung-nhan/chung-nhan1.png', 'Ch·ª©ng nh·∫≠n 1')">
                                            <img src="hinh-chung-nhan/chung-nhan1.png" alt="Ch·ª©ng nh·∫≠n 1">
                                        </div>
                                        <div class="certificate-item" onclick="openCertModal('hinh-chung-nhan/chung-nhan2.png', 'Ch·ª©ng nh·∫≠n 2')">
                                            <img src="hinh-chung-nhan/chung-nhan2.png" alt="Ch·ª©ng nh·∫≠n 2">
                                        </div>
                                        <div class="certificate-item" onclick="openCertModal('hinh-chung-nhan/chung-nhan3.png', 'Ch·ª©ng nh·∫≠n 3')">
                                            <img src="hinh-chung-nhan/chung-nhan3.png" alt="Ch·ª©ng nh·∫≠n 3">
                                        </div>
                                        <div class="certificate-item" onclick="openCertModal('hinh-chung-nhan/chung-nhan4.png', 'Ch·ª©ng nh·∫≠n 4')">
                                            <img src="hinh-chung-nhan/chung-nhan4.png" alt="Ch·ª©ng nh·∫≠n 4">
                                        </div>
                                        <div class="certificate-item" onclick="openCertModal('hinh-chung-nhan/chung-nhan5.png', 'Ch·ª©ng nh·∫≠n 5')">
                                            <img src="hinh-chung-nhan/chung-nhan5.png" alt="Ch·ª©ng nh·∫≠n 5">
                                        </div>
                                        <div class="certificate-item" onclick="openCertModal('hinh-chung-nhan/chung-nhan6.png', 'Ch·ª©ng nh·∫≠n 6')">
                                            <img src="hinh-chung-nhan/chung-nhan6.png" alt="Ch·ª©ng nh·∫≠n 6">
                                        </div>
                                        <div class="certificate-item" onclick="openCertModal('hinh-chung-nhan/chung-nhan7.png', 'Ch·ª©ng nh·∫≠n 7')">
                                            <img src="hinh-chung-nhan/chung-nhan7.png" alt="Ch·ª©ng nh·∫≠n 7">
                                        </div>
                                        <div class="certificate-item" onclick="openCertModal('hinh-chung-nhan/chung-nhan8.png', 'Ch·ª©ng nh·∫≠n 8')">
                                            <img src="hinh-chung-nhan/chung-nhan8.png" alt="Ch·ª©ng nh·∫≠n 8">
                                        </div>
                                        <div class="certificate-item" onclick="openCertModal('hinh-chung-nhan/chung-nhan9.png', 'Ch·ª©ng nh·∫≠n 9')">
                                            <img src="hinh-chung-nhan/chung-nhan9.png" alt="Ch·ª©ng nh·∫≠n 9">
                                        </div>
                                        <div class="certificate-item" onclick="openCertModal('hinh-chung-nhan/chung-nhan10.png', 'Ch·ª©ng nh·∫≠n 10')">
                                            <img src="hinh-chung-nhan/chung-nhan10.png" alt="Ch·ª©ng nh·∫≠n 10">
                                        </div>
                                        <div class="certificate-item" onclick="openCertModal('hinh-chung-nhan/chung-nhan11.png', 'Ch·ª©ng nh·∫≠n 11')">
                                            <img src="hinh-chung-nhan/chung-nhan11.png" alt="Ch·ª©ng nh·∫≠n 11">
                                        </div>
                                        <div class="certificate-item" onclick="openCertModal('hinh-chung-nhan/chung-nhan12.png', 'Ch·ª©ng nh·∫≠n 12')">
                                            <img src="hinh-chung-nhan/chung-nhan12.png" alt="Ch·ª©ng nh·∫≠n 12">
                                        </div>
                                        <div class="certificate-item" onclick="openCertModal('hinh-chung-nhan/chung-nhan13.png', 'Ch·ª©ng nh·∫≠n 13')">
                                            <img src="hinh-chung-nhan/chung-nhan13.png" alt="Ch·ª©ng nh·∫≠n 13">
                                        </div>
                                        <div class="certificate-item" onclick="openCertModal('hinh-chung-nhan/chung-nhan14.png', 'Ch·ª©ng nh·∫≠n 14')">
                                            <img src="hinh-chung-nhan/chung-nhan14.png" alt="Ch·ª©ng nh·∫≠n 14">
                                        </div>
                                    </div>
                                </div>
                                <button class="cert-btn prev-cert-btn" onclick="prevCertificate()">‚Äπ</button>
                                <button class="cert-btn next-cert-btn" onclick="nextCertificate()">‚Ä∫</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section class="products-section reveal">
        <div class="container">
            <h2>S·∫¢N PH·∫®M N·ªîI B·∫¨T</h2>
            <div class="featured-products-wrapper">
                <div class="product-grid" id="featuredProductsGrid">
                    <div class="product-card skeleton-item">
                        <div class="skeleton-img"></div>
                        <div class="skeleton-text"></div>
                        <div class="skeleton-text short"></div>
                        <div class="skeleton-text"></div>
                    </div>
                    <div class="product-card skeleton-item">
                        <div class="skeleton-img"></div>
                        <div class="skeleton-text"></div>
                        <div class="skeleton-text short"></div>
                        <div class="skeleton-text"></div>
                    </div>
                    <div class="product-card skeleton-item">
                        <div class="skeleton-img"></div>
                        <div class="skeleton-text"></div>
                        <div class="skeleton-text short"></div>
                        <div class="skeleton-text"></div>
                    </div>
                    <div class="product-card skeleton-item">
                        <div class="skeleton-img"></div>
                        <div class="skeleton-text"></div>
                        <div class="skeleton-text short"></div>
                        <div class="skeleton-text"></div>
                    </div>
                    <div class="product-card skeleton-item">
                        <div class="skeleton-img"></div>
                        <div class="skeleton-text"></div>
                        <div class="skeleton-text short"></div>
                        <div class="skeleton-text"></div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Carousel gi·ªëng FPTShop -->
    <section class="mini-banners-section reveal">
        <div class="container">
            <div class="carousel-container">
                <div class="carousel-wrapper">
                    <div class="carousel-track" id="carouselTrack">
                        <div class="carousel-item" onclick="openCertModal('hinh-mau/hinh-sanpham-1.png', 'S·∫£n ph·∫©m 1')">
                            <img src="hinh-mau/hinh-sanpham-1.png" alt="S·∫£n ph·∫©m 1">
                        </div>
                        <div class="carousel-item" onclick="openCertModal('hinh-mau/hinh-sanpham-2.png', 'S·∫£n ph·∫©m 2')">
                            <img src="hinh-mau/hinh-sanpham-2.png" alt="S·∫£n ph·∫©m 2">
                        </div>
                        <div class="carousel-item" onclick="openCertModal('hinh-mau/hinh-sanpham-3.png', 'S·∫£n ph·∫©m 3')">
                            <img src="hinh-mau/hinh-sanpham-3.png" alt="S·∫£n ph·∫©m 3">
                        </div>
                        <div class="carousel-item" onclick="openCertModal('hinh-mau/hinh-sanpham-4.png', 'S·∫£n ph·∫©m 4')">
                            <img src="hinh-mau/hinh-sanpham-4.png" alt="S·∫£n ph·∫©m 4">
                        </div>
                        <div class="carousel-item" onclick="openCertModal('hinh-mau/hinh-sanpham-5.png', 'S·∫£n ph·∫©m 5')">
                            <img src="hinh-mau/hinh-sanpham-5.png" alt="S·∫£n ph·∫©m 5">
                        </div>
                        <div class="carousel-item" onclick="openCertModal('hinh-mau/hinh-sanpham-6.png', 'S·∫£n ph·∫©m 6')">
                            <img src="hinh-mau/hinh-sanpham-6.png" alt="S·∫£n ph·∫©m 6">
                        </div>
                        <div class="carousel-item" onclick="openCertModal('hinh-mau/hinh-sanpham-7.png', 'S·∫£n ph·∫©m 7')">
                            <img src="hinh-mau/hinh-sanpham-7.png" alt="S·∫£n ph·∫©m 7">
                        </div>
                        <div class="carousel-item" onclick="openCertModal('hinh-mau/hinh-sanpham-8.png', 'S·∫£n ph·∫©m 8')">
                            <img src="hinh-mau/hinh-sanpham-8.png" alt="S·∫£n ph·∫©m 8">
                        </div>
                    </div>
                </div>
                <button class="carousel-btn prev-btn" onclick="prevCarousel()">‚Äπ</button>
                <button class="carousel-btn next-btn" onclick="nextCarousel()">‚Ä∫</button>
            </div>
        </div>
    </section>
    <section class="projects-section reveal">
        <div class="container">
            <h2>D·ª∞ √ÅN TI√äU BI·ªÇU</h2>
            <div class="projects-form">
                <div class="projects-slideshow">
                    <div class="project-track" id="projectTrack">
                        <div class="project-slide">
                            <div class="project-item" onclick="openCertModal('hinh-du-an/du-an1.png', 'D·ª± √°n 1')">
                                <img src="hinh-du-an/du-an1.png" alt="D·ª± √°n 1">
                            </div>
                            <div class="project-item" onclick="openCertModal('hinh-du-an/du-an2.png', 'D·ª± √°n 2')">
                                <img src="hinh-du-an/du-an2.png" alt="D·ª± √°n 2">
                            </div>
                        </div>
                        <div class="project-slide">
                            <div class="project-item" onclick="openCertModal('hinh-du-an/du-an3.png', 'D·ª± √°n 3')">
                                <img src="hinh-du-an/du-an3.png" alt="D·ª± √°n 3">
                            </div>
                            <div class="project-item" onclick="openCertModal('hinh-du-an/du-an4.png', 'D·ª± √°n 4')">
                                <img src="hinh-du-an/du-an4.png" alt="D·ª± √°n 4">
                            </div>
                        </div>
                        <div class="project-slide">
                            <div class="project-item" onclick="openCertModal('hinh-du-an/du-an5.png', 'D·ª± √°n 5')">
                                <img src="hinh-du-an/du-an5.png" alt="D·ª± √°n 5">
                            </div>
                            <div class="project-item" onclick="openCertModal('hinh-du-an/du-an6.png', 'D·ª± √°n 6')">
                                <img src="hinh-du-an/du-an6.png" alt="D·ª± √°n 6">
                            </div>
                        </div>
                    </div>
                </div>
                <button type="button" class="project-nav-btn project-prev-btn" onclick="prevProjectSlide()">‚Äπ</button>
                <button type="button" class="project-nav-btn project-next-btn" onclick="nextProjectSlide()">‚Ä∫</button>
                <div class="project-indicators">
                    <span class="project-dot active" onclick="currentProjectSlide(1)"></span>
                    <span class="project-dot" onclick="currentProjectSlide(2)"></span>
                    <span class="project-dot" onclick="currentProjectSlide(3)"></span>
                </div>
            </div>
        </div>
    </section>
    <div id="loginModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeLoginForm()">&times;</span>
            <div class="login-container">
                <div class="login-header">
                    <div class="service-icons">
                        <div class="fpt-icon">TaJerMy</div>
                        <div class="arrow">‚Üí</div>
                        <div class="shop-icon">üõçÔ∏è</div>
                    </div>
                    <h2>T√†i kho·∫£n s·ª≠ d·ª•ng d·ªãch v·ª• <span class="fpt-logo">TaJerMy</span></h2>
                </div>
                
                <div class="login-form">
                    <!-- Step 1: Phone -->
                    <div id="loginStep1">
                        <label>T√™n ƒëƒÉng nh·∫≠p / S·ªë ƒëi·ªán tho·∫°i <span class="required">*</span></label>
                        <input type="text" id="loginInput" placeholder="Nh·∫≠p t√™n ƒëƒÉng nh·∫≠p ho·∫∑c s·ªë ƒëi·ªán tho·∫°i" class="login-input">
                        <button class="continue-btn" onclick="handleLoginStep1()">Ti·∫øp t·ª•c</button>
                    </div>

                    <!-- Step 2: Password -->
                    <div id="loginStep2" style="display: none;">
                        <div class="login-header-step2"><button class="back-btn" onclick="backToStep1()">‚Üê</button> Nh·∫≠p m·∫≠t kh·∫©u</div>
                        <label>M·∫≠t kh·∫©u <span class="required">*</span></label>
                        <input type="password" id="loginPassword" placeholder="Nh·∫≠p m·∫≠t kh·∫©u" class="login-input">
                        <button class="continue-btn" onclick="handleLoginStep2()">ƒêƒÉng nh·∫≠p</button>
                    </div>

                    <!-- Register Step -->
                    <div id="registerStep" style="display: none;">
                        <span onclick="backToLogin()" style="position: absolute; top: 10px; left: 20px; font-size: 30px; font-weight: bold; color: #aaa; cursor: pointer; z-index: 10;">‚Üê</span>
                        <div style="text-align: center; font-weight: bold; font-size: 18px; margin-bottom: 15px; margin-top: -10px;">ƒêƒÉng k√Ω t√†i kho·∫£n</div>
                        
                        <label>T√™n ƒëƒÉng nh·∫≠p <span class="required">*</span></label>
                        <input type="text" id="regUsername" class="login-input" placeholder="Nh·∫≠p t√™n ƒëƒÉng nh·∫≠p" style="margin-bottom: 5px;">
                        
                        <label>S·ªë ƒëi·ªán tho·∫°i <span class="required">*</span></label>
                        <input type="text" id="regPhone" class="login-input" placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i" style="margin-bottom: 5px;">
                        
                        <label>Email <span class="required">*</span></label>
                        <input type="email" id="regGmail" class="login-input" placeholder="Nh·∫≠p email" style="margin-bottom: 5px;">
                        
                        <label>M·∫≠t kh·∫©u <span class="required">*</span></label>
                        <input type="password" id="regPass" class="login-input" placeholder="Nh·∫≠p m·∫≠t kh·∫©u" style="margin-bottom: 5px;">
                        
                        <label>M√£ x√°c nh·∫≠n <span class="required">*</span></label>
                        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                            <input type="text" id="regCode" class="login-input" placeholder="Nh·∫≠p m√£ x√°c nh·∫≠n" style="flex: 1; margin-bottom: 0;">
                            <button type="button" class="continue-btn" onclick="sendVerificationCode()" style="width: auto; margin: 0; padding: 0 15px;">Nh·∫≠n m√£</button>
                        </div>
                        
                        <button class="continue-btn" onclick="handleRegister()">ƒêƒÉng k√Ω</button>
                        <div id="registerMessage" style="text-align: center; margin-top: 2px; font-weight: bold;"></div>
                    </div>

                    <p class="terms-text">
                        B·∫±ng c√°ch ti·∫øp t·ª•c, b·∫°n ƒë·ªìng √Ω v·ªõi 
                        <a href="#" class="link">ƒêi·ªÅu kho·∫£n</a> v√† 
                        <a href="#" class="link">Ch√≠nh s√°ch</a> b·∫£o m·∫≠t c·ªßa TaJerMy
                    </p>
                    
                    <div class="divider">
                        <span>Ho·∫∑c ƒëƒÉng nh·∫≠p b·∫±ng</span>
                    </div>      
                    <div class="social-login">
                        <button class="social-btn apple-btn" onclick="showRegisterForm()">ƒêƒÉng k√Ω</button>
                        <button class="social-btn google-btn">
                            <img src="hinh-anh/google-logo.png" alt="Google" class="google-icon">
                        </button>
                        <button class="social-btn facebook-btn">
                            <img src="hinh-anh/fb-logo.png" alt="Facebook" class="facebook-icon">
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        // Check session on load
        document.addEventListener('DOMContentLoaded', function() {
            checkLoginStatus();
        });

        let isLoggedIn = false;
        let currentEditingImage = null; // Bi·∫øn l∆∞u tr·ªØ ·∫£nh ƒëang ƒë∆∞·ª£c s·ª≠a
        let currentEditingText = null; // Bi·∫øn l∆∞u tr·ªØ vƒÉn b·∫£n ƒëang ƒë∆∞·ª£c s·ª≠a

        function checkLoginStatus() {
            fetch('check_session.php', { credentials: 'include' })
                .then(response => response.json())
                .then(data => {
                    const accountDropdown = document.querySelector('.account-dropdown');
                    if (data.logged_in) {
                        // L∆∞u position v√†o localStorage
                        if (data.position) {
                            saveUserPosition(data.position);
                        }
                        
                        // Chu·∫©n ho√° position v·ªÅ kh√¥ng d·∫•u ƒë·ªÉ so s√°nh
                        const pos = (data.position || '').toString().toLowerCase();

                        // Ki·ªÉm tra quy·ªÅn Qu·∫£n tr·ªã vi√™n
                        if (pos !== 'quan-tri-vien' && pos !== 'admin') {
                            // N·∫øu kh√¥ng ph·∫£i admin -> xo√° quy·ªÅn v√† ƒë∆∞a v·ªÅ trang kh√°ch
                            if (typeof clearUserPosition === 'function') {
                                clearUserPosition();
                            }
                            window.location.href = 'index.html';
                            return;
                        }

                        isLoggedIn = true;
                        if (accountDropdown) accountDropdown.classList.add('logged-in');
                        
                        const usernameDisplay = document.getElementById('usernameDisplay');
                        if (usernameDisplay) {
                            usernameDisplay.innerText = data.username;
                            usernameDisplay.style.display = 'block';
                        }
                        // Hide login modal if open
                        closeLoginForm();
                        
                        // Load d·ªØ li·ªáu ƒë√£ l∆∞u tr∆∞·ªõc ƒë√≥ & G√°n ID
                        initializeContentSystem();
                        // K√≠ch ho·∫°t giao di·ªán ch·ªânh s·ª≠a
                        initAdminInterface();
                    } else {
                        // Ch∆∞a ƒëƒÉng nh·∫≠p -> ƒë∆∞a v·ªÅ trang ch√≠nh
                        if (typeof clearUserPosition === 'function') {
                            clearUserPosition();
                        }
                        window.location.href = 'index.html';
                        isLoggedIn = false;
                    }
                })
                .catch(err => {
                    console.error('Session check failed', err);
                    // Fallback cho demo n·∫øu kh√¥ng c√≥ backend
                    // initAdminInterface(); 
                });
        }

        // H·ªá th·ªëng qu·∫£n l√Ω n·ªôi dung: G√°n ID v√† Load d·ªØ li·ªáu
        function initializeContentSystem() {
            // 1. G√°n ID duy nh·∫•t cho c√°c ph·∫ßn t·ª≠ c√≥ th·ªÉ s·ª≠a
            const images = document.querySelectorAll('header img, main img, footer img');
            images.forEach((img, index) => {
                if (!img.hasAttribute('data-uid')) {
                    img.setAttribute('data-uid', 'img-' + index);
                }
            });

            const textTags = ['h1', 'h2', 'h3', 'h4', 'h5', 'p', 'span', 'li', 'a', 'td', 'th'];
            let textIndex = 0;
            textTags.forEach(tagName => {
                document.querySelectorAll(`header ${tagName}, main ${tagName}, footer ${tagName}`).forEach(el => {
                    if (!el.hasAttribute('data-uid') && el.innerText.trim().length > 0 && !el.closest('.admin-edit-btn')) {
                        el.setAttribute('data-uid', 'txt-' + textIndex++);
                    }
                });
            });

            // Load d·ªØ li·ªáu t·ª´ localStorage
            const savedData = JSON.parse(localStorage.getItem('siteContent') || '{}');
            for (const [uid, value] of Object.entries(savedData)) {
                const element = document.querySelector(`[data-uid="${uid}"]`);
                if (element) {
                    if (uid.startsWith('img-')) {
                        element.src = value;
                    } else if (uid.startsWith('contact-')) {
                        element.href = value;
                    } else {
                        // Khi load, ch∆∞a c√≥ n√∫t s·ª≠a, n√™n c√≥ th·ªÉ set innerText an to√†n
                        element.innerText = value;
                    }
                }
            }
        }

        // H√†m kh·ªüi t·∫°o giao di·ªán Admin (Th√™m n√∫t s·ª≠a)
        function initAdminInterface() {
            console.log("Admin Interface Initialized");
            
            // 1. Th√™m n√∫t s·ª≠a cho H√åNH ·∫¢NH
            const images = document.querySelectorAll('img');
            images.forEach(img => {
                // B·ªè qua c√°c icon nh·ªè ho·∫∑c ·∫£nh trong n√∫t
                if (img.width < 50 || img.height < 50 || img.closest('.admin-edit-btn')) return;
                
                // B·ªè qua c√°c icon li√™n k·∫øt b√™n ph·∫£i (phone, zalo, youtube, facebook)
                if (img.closest('.phone-contact') || img.closest('.zalo-contact') || 
                    img.closest('.youtube-contact') || img.closest('.facebook-contact')) {
                    return;
                }

                const btn = document.createElement('button');
                btn.innerHTML = '‚úèÔ∏è Ch·ªânh s·ª≠a';
                btn.className = 'admin-edit-btn admin-edit-btn-img';
                btn.onclick = (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    openImageEditModal(img); // M·ªü modal ch·ªânh s·ª≠a
                };

                // C·∫ßn parent c√≥ position relative ƒë·ªÉ ƒë·ªãnh v·ªã n√∫t
                const parent = img.parentElement;
                if (parent) {
                    const computedStyle = window.getComputedStyle(parent);
                    if (computedStyle.position === 'static') {
                        parent.style.position = 'relative';
                    }
                    parent.appendChild(btn);
                }
            });

            // 2. Th√™m n√∫t s·ª≠a cho VƒÇN B·∫¢N
            // Danh s√°ch c√°c th·∫ª ch·ª©a vƒÉn b·∫£n c·∫ßn s·ª≠a
            const textTags = ['h1', 'h2', 'h3', 'h4', 'h5', 'p', 'span', 'li', 'a', 'td', 'th'];
            
            textTags.forEach(tagName => {
                const elements = document.querySelectorAll(tagName);
                elements.forEach(el => {
                    // Ki·ªÉm tra xem element c√≥ ch·ª©a text tr·ª±c ti·∫øp kh√¥ng (tr√°nh th√™m v√†o container r·ªóng)
                    let hasDirectText = false;
                    for (let i = 0; i < el.childNodes.length; i++) {
                        if (el.childNodes[i].nodeType === Node.TEXT_NODE && el.childNodes[i].textContent.trim().length > 0) {
                            hasDirectText = true;
                            break;
                        }
                    }

                    // ƒêi·ªÅu ki·ªán l·ªçc: C√≥ text, kh√¥ng ph·∫£i n√∫t admin, kh√¥ng n·∫±m trong n√∫t admin
                    if (hasDirectText && !el.classList.contains('admin-edit-btn') && !el.closest('.admin-edit-btn')) {
                        const btn = document.createElement('button');
                        btn.innerHTML = '‚úèÔ∏è';
                        btn.className = 'admin-edit-btn';
                        btn.title = 'Ch·ªânh s·ª≠a vƒÉn b·∫£n';
                        btn.onclick = (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            openTextEditModal(el); // M·ªü modal s·ª≠a vƒÉn b·∫£n
                        };
                        el.appendChild(btn);
                    }
                });
            });

        }

        function handleAccountClick(event) {
            event.stopPropagation(); // NgƒÉn event bubble l√™n c√°c ph·∫ßn t·ª≠ cha
            
            const accountMenu = document.getElementById('accountMenu');
            
            // Ki·ªÉm tra tr·∫°ng th√°i ƒëƒÉng nh·∫≠p
            if (!isLoggedIn) {
                // Ch∆∞a ƒëƒÉng nh·∫≠p ‚Üí hi·ªÉn th·ªã form ƒëƒÉng nh·∫≠p
                toggleLoginForm();
            } else {
                // ƒê√£ ƒëƒÉng nh·∫≠p ‚Üí toggle hi·ªÉn th·ªã menu
                if (accountMenu.style.display === 'block') {
                    accountMenu.style.display = 'none';
                } else {
                    accountMenu.style.display = 'block';
                }
            }
        }

        // ƒê√≥ng menu khi click ra ngo√†i
        document.addEventListener('click', function(event) {
            const accountDropdown = document.querySelector('.account-dropdown');
            const accountMenu = document.getElementById('accountMenu');
            
            if (accountDropdown && !accountDropdown.contains(event.target)) {
                accountMenu.style.display = 'none';
            }
        });

        function handleLoginStep1() {
            const inputVal = document.getElementById('loginInput').value;
            if (!inputVal) {
                alert('Vui l√≤ng nh·∫≠p t√™n ƒëƒÉng nh·∫≠p ho·∫∑c s·ªë ƒëi·ªán tho·∫°i!');
                return;
            }
            // Switch to step 2
            document.getElementById('loginStep1').style.display = 'none';
            document.getElementById('loginStep2').style.display = 'block';
        }

        function backToStep1() {
            document.getElementById('loginStep1').style.display = 'block';
            document.getElementById('loginStep2').style.display = 'none';
        }

        function handleLoginStep2() {
            const inputVal = document.getElementById('loginInput').value;
            const password = document.getElementById('loginPassword').value;
            
            if (!password) {
                alert('Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u!');
                return;
            }

            fetch('login.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: inputVal, password: password })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // L∆∞u position v√†o localStorage
                    if (data.position) {
                        saveUserPosition(data.position);
                    }
                    
                    // Chuy·ªÉn h∆∞·ªõng tr·ª±c ti·∫øp kh√¥ng c·∫ßn th√¥ng b√°o
                    if (data.redirect) {
                        window.location.href = data.redirect;
                    } else {
                        window.location.reload();
                    }
                } else {
                    alert(data.message);
                }
            })
            .catch(error => console.error('Error:', error));
        }

        function handleLogout() {
            // X√≥a position kh·ªèi localStorage
            clearUserPosition();
            
            fetch('logout.php')
                .then(() => {
                    window.location.href = 'index.html'; // Logout xong v·ªÅ trang ch·ªß th∆∞·ªùng
                });
        }

        function showRegisterForm() {
            // ·∫®n c√°c ph·∫ßn c·ªßa form ƒëƒÉng nh·∫≠p
            document.getElementById('loginStep1').style.display = 'none';
            document.getElementById('loginStep2').style.display = 'none';
            document.querySelector('.terms-text').style.display = 'none';
            document.querySelector('.divider').style.display = 'none';
            document.querySelector('.social-login').style.display = 'none';
            
            // Hi·ªán form ƒëƒÉng k√Ω
            document.getElementById('registerStep').style.display = 'block';
            
            // Reset form ƒëƒÉng k√Ω
            document.getElementById('registerMessage').innerText = '';
            document.getElementById('regUsername').value = '';
            document.getElementById('regPhone').value = '';
            document.getElementById('regGmail').value = '';
            document.getElementById('regPass').value = '';
            if(document.getElementById('regCode')) document.getElementById('regCode').value = '';
        }

        function backToLogin() {
            document.getElementById('registerStep').style.display = 'none';
            document.getElementById('loginStep1').style.display = 'block';
            document.querySelector('.terms-text').style.display = 'block';
            document.querySelector('.divider').style.display = 'block';
            document.querySelector('.social-login').style.display = 'flex';
        }

        function sendVerificationCode() {
            const gmail = document.getElementById('regGmail').value;
            if (!gmail) {
                alert('Vui l√≤ng nh·∫≠p email ƒë·ªÉ nh·∫≠n m√£!');
                return;
            }
            
            const formData = new FormData();
            formData.append('send', 'true');
            formData.append('gmail', gmail);

            fetch('xacnhangamil.php', {
                method: 'POST',
                body: formData
            })
            .then(response => response.text())
            .then(data => {
                alert(data);
            })
            .catch(error => {
                console.error('Error:', error);
                alert('C√≥ l·ªói x·∫£y ra khi g·ª≠i m√£.');
            });
        }

        function handleRegister() {
            const user = document.getElementById('regUsername').value;
            const phone = document.getElementById('regPhone').value;
            const gmail = document.getElementById('regGmail').value;
            const pass = document.getElementById('regPass').value;
            const code = document.getElementById('regCode').value;
            const msgDiv = document.getElementById('registerMessage');

            if (!user || !phone || !gmail || !pass || !code) {
                msgDiv.style.color = 'red';
                msgDiv.innerText = 'Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin v√† m√£ x√°c nh·∫≠n!';
                return;
            }

            // Verify code first
            const formData = new FormData();
            formData.append('code', code);

            fetch('check_code.php', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // Code correct, proceed to register
                    fetch('register.php', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username: user, phone: phone, gmail: gmail, password: pass })
                    })
                    .then(response => response.json())
                    .then(regData => {
                        if (regData.status === 'success') {
                            msgDiv.style.color = '#4CAF50';
                            msgDiv.innerText = 'ƒêƒÉng k√Ω th√†nh c√¥ng!';
                        } else {
                            msgDiv.style.color = 'red';
                            msgDiv.innerText = regData.message;
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        msgDiv.style.color = 'red';
                        msgDiv.innerText = 'C√≥ l·ªói x·∫£y ra, vui l√≤ng th·ª≠ l·∫°i.';
                    });
                } else {
                    msgDiv.style.color = 'red';
                    msgDiv.innerText = 'Sai m√£ x√°c nh·∫≠n';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                msgDiv.style.color = 'red';
                msgDiv.innerText = 'L·ªói ki·ªÉm tra m√£ x√°c nh·∫≠n.';
            });
        }

        function toggleRegisterPassword(btn) {
            const passwordInput = document.getElementById('regPass');
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                btn.textContent = 'üôà'; // Icon ·∫©n
            } else {
                passwordInput.type = 'password';
                btn.textContent = 'üëÅÔ∏è'; // Icon hi·ªán
            }
        }

        function toggleLoginForm() {
            document.getElementById('loginModal').style.display = 'block';
            // ƒê·∫£m b·∫£o quay v·ªÅ m√†n h√¨nh ƒëƒÉng nh·∫≠p m·∫∑c ƒë·ªãnh khi m·ªü modal
            if (typeof backToLogin === 'function') backToLogin();
            if (typeof backToStep1 === 'function') backToStep1(); 
            if(document.getElementById('loginInput')) document.getElementById('loginInput').value = '';
            if(document.getElementById('loginPassword')) document.getElementById('loginPassword').value = '';
        }
        
        function closeLoginForm() {
            document.getElementById('loginModal').style.display = 'none';
        }
        
        window.onclick = function(event) {
            var modal = document.getElementById('loginModal');
            var certModal = document.getElementById('certModal');
            var imageEditModal = document.getElementById('imageEditModal');
            var textEditModal = document.getElementById('textEditModal');
            var linkEditModal = document.getElementById('linkEditModal');
            if (event.target == modal) {
                modal.style.display = 'none';
            }
            if (event.target == certModal) {
                certModal.style.display = 'none';
            }
            if (event.target == imageEditModal) {
                closeImageEditModal();
            }
            if (event.target == textEditModal) {
                closeTextEditModal();
            }
            if (event.target == linkEditModal) {
                closeLinkEditModal();
            }
        }
        
        let currentSlide = 0;
        const slides = document.querySelectorAll('.slide');
        
        function showSlide(index) {
            slides.forEach(slide => slide.classList.remove('active'));
            slides[index].classList.add('active');
        }
        
        function nextSlide() {
            currentSlide = (currentSlide + 1) % slides.length;
            showSlide(currentSlide);
        }
        
        function prevSlide() {
            currentSlide = (currentSlide - 1 + slides.length) % slides.length;
            showSlide(currentSlide);
        }
        
        setInterval(nextSlide, 5000);
        
        // Project slideshow ping-pong logic
        let currentProjectSlideIndex = 0;
        let projectDirection = 1;
        let projectAutoSlideInterval;
        const projectTrack = document.getElementById('projectTrack');
        const projectSlides = document.querySelectorAll('.project-slide');
        const projectDots = document.querySelectorAll('.project-dot');
        const maxProjectIndex = projectSlides.length - 1;
        
        function updateProjectSlide() {
            const translateX = -(currentProjectSlideIndex * 33.333);
            projectTrack.style.transform = `translateX(${translateX}%)`;
            updateProjectButtons();
            updateProjectDots();
        }
        
        function updateProjectDots() {
            projectDots.forEach((dot, index) => {
                dot.classList.toggle('active', index === currentProjectSlideIndex);
            });
        }
        
        function updateProjectButtons() {
            const prevBtn = document.querySelector('.project-prev-btn');
            const nextBtn = document.querySelector('.project-next-btn');
            
            if (currentProjectSlideIndex === 0 && projectDirection === 1) {
                prevBtn.style.opacity = '0';
                prevBtn.style.pointerEvents = 'none';
            } else {
                prevBtn.style.opacity = '1';
                prevBtn.style.pointerEvents = 'auto';
            }
            
            if (currentProjectSlideIndex === maxProjectIndex && projectDirection === -1) {
                nextBtn.style.opacity = '0';
                nextBtn.style.pointerEvents = 'none';
            } else {
                nextBtn.style.opacity = '1';
                nextBtn.style.pointerEvents = 'auto';
            }
        }
        
        function autoProjectSlide() {
            if (currentProjectSlideIndex >= maxProjectIndex) {
                projectDirection = -1;
            } else if (currentProjectSlideIndex <= 0) {
                projectDirection = 1;
            }
            
            currentProjectSlideIndex += projectDirection;
            updateProjectSlide();
        }
        
        function nextProjectSlide() {
            clearInterval(projectAutoSlideInterval);
            
            if (currentProjectSlideIndex < maxProjectIndex) {
                currentProjectSlideIndex++;
                projectDirection = 1;
            } else {
                projectDirection = -1;
                currentProjectSlideIndex--;
            }
            
            updateProjectSlide();
            projectAutoSlideInterval = setInterval(autoProjectSlide, 3000);
        }
        
        function prevProjectSlide() {
            clearInterval(projectAutoSlideInterval);
            
            if (currentProjectSlideIndex > 0) {
                currentProjectSlideIndex--;
                projectDirection = -1;
            } else {
                projectDirection = 1;
                currentProjectSlideIndex++;
            }
            
            updateProjectSlide();
            projectAutoSlideInterval = setInterval(autoProjectSlide, 3000);
        }
        
        function currentProjectSlide(n) {
            clearInterval(projectAutoSlideInterval);
            currentProjectSlideIndex = n - 1;
            projectDirection = 1;
            updateProjectSlide();
            projectAutoSlideInterval = setInterval(autoProjectSlide, 3000);
        }
        
        updateProjectSlide();
        projectAutoSlideInterval = setInterval(autoProjectSlide, 3000);
        
        // Carousel ping-pong logic
        let currentCarouselIndex = 0;
        let direction = 1;
        let autoSlideInterval;
        const track = document.getElementById('carouselTrack');
        const carouselItems = document.querySelectorAll('.carousel-item');
        const totalItems = carouselItems.length;
        const slidesToShow = 3;
        const maxIndex = totalItems - slidesToShow;
        
        function updateCarousel() {
            const translateX = -(currentCarouselIndex * (100 / slidesToShow));
            track.style.transform = `translateX(${translateX}%)`;
            updateCarouselButtons();
        }
        
        function updateCarouselButtons() {
            const prevBtn = document.querySelector('.carousel-container .prev-btn');
            const nextBtn = document.querySelector('.carousel-container .next-btn');
            
            if (currentCarouselIndex === 0 && direction === 1) {
                prevBtn.style.opacity = '0';
                prevBtn.style.pointerEvents = 'none';
            } else {
                prevBtn.style.opacity = '1';
                prevBtn.style.pointerEvents = 'auto';
            }
            
            if (currentCarouselIndex === maxIndex && direction === -1) {
                nextBtn.style.opacity = '0';
                nextBtn.style.pointerEvents = 'none';
            } else {
                nextBtn.style.opacity = '1';
                nextBtn.style.pointerEvents = 'auto';
            }
        }
        
        function autoSlide() {
            if (currentCarouselIndex >= maxIndex) {
                direction = -1;
            } else if (currentCarouselIndex <= 0) {
                direction = 1;
            }
            
            currentCarouselIndex += direction;
            updateCarousel();
        }
        
        function nextCarousel() {
            clearInterval(autoSlideInterval);
            
            if (currentCarouselIndex < maxIndex) {
                currentCarouselIndex++;
                direction = 1;
            } else {
                direction = -1;
                currentCarouselIndex--;
            }
            
            updateCarousel();
            autoSlideInterval = setInterval(autoSlide, 3000);
        }
        
        function prevCarousel() {
            clearInterval(autoSlideInterval);
            
            if (currentCarouselIndex > 0) {
                currentCarouselIndex--;
                direction = -1;
            } else {
                direction = 1;
                currentCarouselIndex++;
            }
            
            updateCarousel();
            autoSlideInterval = setInterval(autoSlide, 3000);
        }
        
        updateCarousel();
        autoSlideInterval = setInterval(autoSlide, 3000);
        
        // Certificate carousel ping-pong logic
        let currentCertIndex = 0;
        let certDirection = 1;
        let certAutoSlideInterval;
        const certTrack = document.getElementById('certificateTrack');
        const certItems = document.querySelectorAll('.certificate-item');
        const maxCertIndex = certItems.length - 1;
        
        function updateCertificate() {
            const translateX = -(currentCertIndex * 100);
            certTrack.style.transform = `translateX(${translateX}%)`;
            updateCertButtons();
        }
        
        function updateCertButtons() {
            const prevBtn = document.querySelector('.prev-cert-btn');
            const nextBtn = document.querySelector('.next-cert-btn');
            
            if (currentCertIndex === 0 && certDirection === 1) {
                prevBtn.style.opacity = '0';
                prevBtn.style.pointerEvents = 'none';
            } else {
                prevBtn.style.opacity = '1';
                prevBtn.style.pointerEvents = 'auto';
            }
            
            if (currentCertIndex === maxCertIndex && certDirection === -1) {
                nextBtn.style.opacity = '0';
                nextBtn.style.pointerEvents = 'none';
            } else {
                nextBtn.style.opacity = '1';
                nextBtn.style.pointerEvents = 'auto';
            }
        }
        
        function autoCertSlide() {
            if (currentCertIndex >= maxCertIndex) {
                certDirection = -1;
            } else if (currentCertIndex <= 0) {
                certDirection = 1;
            }
            
            currentCertIndex += certDirection;
            updateCertificate();
        }
        
        function nextCertificate() {
            clearInterval(certAutoSlideInterval);
            
            if (currentCertIndex < maxCertIndex) {
                currentCertIndex++;
                certDirection = 1;
            } else {
                certDirection = -1;
                currentCertIndex--;
            }
            
            updateCertificate();
            certAutoSlideInterval = setInterval(autoCertSlide, 3000);
        }
        
        function prevCertificate() {
            clearInterval(certAutoSlideInterval);
            
            if (currentCertIndex > 0) {
                currentCertIndex--;
                certDirection = -1;
            } else {
                certDirection = 1;
                currentCertIndex++;
            }
            
            updateCertificate();
            certAutoSlideInterval = setInterval(autoCertSlide, 3000);
        }
        
        updateCertificate();
        certAutoSlideInterval = setInterval(autoCertSlide, 3000);
        
                // Category data for dropdown hover
               // Category data for dropdown hover
        const categoryData = {
            'Gi∆∞·ªùng': ['Gi∆∞·ªùng b·ªánh c∆° b·∫£n', 'Gi∆∞·ªùng chuy√™n d·ª•ng (ICU, s·∫£n khoa)', 'Gi∆∞·ªùng ƒëi·ªÅu ch·ªânh ƒë·ªô cao/ t∆∞ th·∫ø (gi∆∞·ªùng ƒëi·ªán)', 'Gi∆∞·ªùng chƒÉm s√≥c t·∫°i nh√†'],
            'Xe lƒÉn': ['Xe lƒÉn tay (ng∆∞·ªùi d√πng t·ª± ƒë·∫©y)', 'Xe lƒÉn ƒë·∫©y sau (ng∆∞·ªùi chƒÉm s√≥c ƒë·∫©y)', 'Xe lƒÉn ƒëi·ªán', 'Xe lƒÉn th·ªÉ thao', 'Xe lƒÉn g·∫•p g·ªçn/ di chuy·ªÉn', 'Xe lƒÉn l√™n xu·ªëng c·∫ßu thang'],
            'Xe Scooter ƒëi·ªán': ['Lo·∫°i di chuy·ªÉn trong nh√†/ ƒë∆∞·ªùng b·∫±ng ph·∫≥ng', 'Lo·∫°i ƒë·ªãa h√¨nh (b√°nh l·ªõn, ƒëi ƒë∆∞·ªùng d√†i)', 'Lo·∫°i g·∫•p g·ªçn/ th√°o r·ªùi'],
            'BƒÉng ca': ['BƒÉng ca c·∫•p c·ª©u (c·ªë ƒë·ªãnh)', 'BƒÉng ca ƒë·∫©y (c√≥ b√°nh xe)', 'BƒÉng ca g·∫•p (v·∫≠n chuy·ªÉn)', 'BƒÉng ca chuy√™n d·ª•ng (ch·ªëng s·ªëc, ch·ª•p X-Quang)', 'ƒê·ªám v·∫≠n chuy·ªÉn'],
            'T·ªß': ['T·ªß ƒë·ª±ng thu·ªëc', 'T·ªß ƒë·ª±ng h·ªì s∆° b·ªánh √°n', 'T·ªß tr∆∞ng b√†y/ l∆∞u tr·ªØ d·ª•ng c·ª•', 'T·ªß ƒë·∫ßu gi∆∞·ªùng b·ªánh'],
            'M√°y t·∫°o oxy': ['M√°y t·∫°o oxy t·∫°i nh√† (lo·∫°i l·ªõn)', 'M√°y t·∫°o oxy x√°ch tay/ di ƒë·ªông', 'M√°y t·∫°o oxy d√≤ng cao (cho tr·ªã li·ªáu ƒë·∫∑c bi·ªát)'],
            'M√°y ƒëo': ['M√°y ƒëo huy·∫øt √°p', 'M√°y ƒëo ƒë∆∞·ªùng huy·∫øt', 'M√°y ƒëo n·ªìng ƒë·ªô oxy trong m√°u (SpO2)', 'M√°y ƒëo th√¢n nhi·ªát', 'M√°y ƒëo tim (ECG di ƒë·ªông)', 'C√¢n s·ª©c kh·ªèe (c∆°/ ƒëi·ªán t·ª≠)'],
            'M√°y x√¥ng': ['M√°y x√¥ng kh√≠ dung ki·ªÉu n√©n', 'M√°y x√¥ng si√™u √¢m', 'M√°y x√¥ng m√†ng (mesh)'],
            'M√°y h√∫t d·ªãch': ['M√°y h√∫t d·ªãch ƒë·ªÉ b√†n/ c·ªë ƒë·ªãnh', 'M√°y h√∫t d·ªãch x√°ch tay/ di ƒë·ªông'],
            'M√°y massage': ['M√°y massage c·∫ßm tay (gi·∫£m ƒëau c∆°)', 'ƒêai/ gh·∫ø massage to√†n th√¢n', 'M√°y massage ch√¢n (xoa b√≥p, l∆∞u th√¥ng m√°u)', 'Thi·∫øt b·ªã massage tr·ªã li·ªáu (nh∆∞ s√≥ng si√™u √¢m, laser c·∫•p th·∫•p)'],
            'Thi·∫øt b·ªã t·∫≠p': ['Thi·∫øt b·ªã t·∫≠p v·∫≠n ƒë·ªông th·ª• ƒë·ªông (CPM)', 'Thi·∫øt b·ªã t·∫≠p ƒëi/ thƒÉng b·∫±ng', 'Thi·∫øt b·ªã t·∫≠p ph·ª•c h·ªìi ch·ª©c nƒÉng tay/ ch√¢n', 'M√°y t·∫≠p th·ªÉ d·ª•c chuy√™n bi·ªát (xe ƒë·∫°p, treadmill cho ph·ª•c h·ªìi)', 'D·ª•ng c·ª• t·∫≠p tr·ªã li·ªáu (b√≥ng, d√¢y kh√°ng l·ª±c, t·∫° tay nh·∫π)'],
            'N·ªám': ['N·ªám ch·ªëng lo√©t (h∆°i, x·ªëp, gel)', 'N·ªám b·ªánh vi·ªán ti√™u chu·∫©n', 'N·ªám n√¢ng ƒë·ª° c∆° th·ªÉ (memory foam, cao su)'],
            'D·ª•ng c·ª• h·ªó tr·ª£': ['H·ªó tr·ª£ di chuy·ªÉn (khung t·∫≠p ƒëi, g·∫≠y ch·ªëng, n·∫°ng)', 'H·ªó tr·ª£ v·ªá sinh (b√¥ v·ªá sinh, b·ªìn c·∫ßu n√¢ng)', 'H·ªó tr·ª£ t·∫Øm (gh·∫ø t·∫Øm, th·∫£m ch·ªëng tr∆∞·ª£t)', 'H·ªó tr·ª£ m·∫∑c qu·∫ßn √°o', 'H·ªó tr·ª£ ƒÉn u·ªëng (th√¨a, ƒë≈©a, tay c·∫ßm ch·ªânh)'],
            'Thi·∫øt b·ªã y t·∫ø kh√°c': ['ƒê√®n kh√°m b·ªánh', 'M√°y kh·ª≠ rung tim (AED)', 'B∆°m ti√™m ƒëi·ªán', 'H·ªôp ƒë·ª±ng d·ª•ng c·ª• v√¥ tr√πng', 'V√† r·∫•t nhi·ªÅu thi·∫øt b·ªã chuy√™n s√¢u kh√°c']
        };
        
        function renderCategoryDetail(categoryName){
            const categoryDetail = document.getElementById('categoryDetail');
            if (!categoryDetail || !categoryData[categoryName]) return;
            const items = categoryData[categoryName];
            const itemsPerColumn = Math.ceil(items.length / 3);
            let columns = ['', '', ''];
            items.forEach((item, index) => {
                const columnIndex = Math.floor(index / itemsPerColumn);
                columns[columnIndex] += `<li class="detail-item" data-group="${categoryName}" data-type="${item}">${item}</li>`;
            });
            categoryDetail.innerHTML = `
                <div class="detail-column">
                    <h4>${categoryName}</h4>
                    <ul>${columns[0]}</ul>
                </div>
                <div class="detail-column">
                    <ul>${columns[1]}</ul>
                </div>
                <div class="detail-column">
                    <ul>${columns[2]}</ul>
                </div>
            `;
        }

        // Ch·ªâ d√πng click ƒë·ªÉ m·ªü chi ti·∫øt danh m·ª•c
        document.querySelectorAll('.submenu-content .brand-item').forEach(item => {
            item.addEventListener('click', function(e){
                e.preventDefault();
                const categoryName = this.getAttribute('data-category') || this.textContent.trim();
                renderCategoryDetail(categoryName);
            });
        });

        // Desktop hover detail click-through
        const detailEl = document.getElementById('categoryDetail');
        if (detailEl) {
            detailEl.addEventListener('click', function(e) {
                const li = e.target.closest('.detail-item');
                if (!li) return;
                const group = li.getAttribute('data-group') || '';
                const type = li.getAttribute('data-type') || '';
                const url = `quan-tri-vien-sanpham.html?groups=${encodeURIComponent(group)}&types=${encodeURIComponent(type)}`;
                window.location.href = url;
            });
        }

        // Mobile Dropdown Category Handling
        document.addEventListener('DOMContentLoaded', function() {
            const dropdownBtn = document.querySelector('.dropdown-btn');
            const dropdownContent = document.querySelector('.dropdown-content');
            const hasSubmenu = document.querySelector('.has-submenu');
            
            // L∆∞u HTML g·ªëc c·ªßa dropdown
            const originalDropdownHTML = dropdownContent.innerHTML;
            
            // Icon paths
            const categoryIcons = {
                'Gi∆∞·ªùng': 'icon-hinhdanhmuc/nhom-giuong.png',
                'Xe lƒÉn': 'icon-hinhdanhmuc/nhom-xelan.png',
                'Xe Scooter ƒëi·ªán': 'icon-hinhdanhmuc/nhom-xedien.png',
                'BƒÉng ca': 'icon-hinhdanhmuc/nhom-bangca.png',
                'T·ªß': 'icon-hinhdanhmuc/nhom-tu.png',
                'M√°y t·∫°o oxy': 'icon-hinhdanhmuc/nhom-maytaooxy.png',
                'M√°y ƒëo': 'icon-hinhdanhmuc/nhom-maydo.png',
                'M√°y x√¥ng': 'icon-hinhdanhmuc/nhom-xong.png',
                'M√°y h√∫t d·ªãch': 'icon-hinhdanhmuc/nhom-mayhutdich.png',
                'M√°y massage': 'icon-hinhdanhmuc/nhom-massage.png',
                'Thi·∫øt b·ªã t·∫≠p': 'icon-hinhdanhmuc/nhom-maytap.png',
                'N·ªám': 'icon-hinhdanhmuc/nhom-nem.png',
                'D·ª•ng c·ª• h·ªó tr·ª£': 'icon-hinhdanhmuc/nhom-dungcuhotro.png',
                'Thi·∫øt b·ªã y t·∫ø kh√°c': 'icon-hinhdanhmuc/nhom-thietbiyte.png'
            };
            
            // H√†m t·∫°o HTML cho danh m·ª•c s·∫£n ph·∫©m
            function createCategoryHTML() {
                let gridHTML = '<div class="sheet-category-grid">';
                
                Object.keys(categoryData).forEach(categoryName => {
                    const iconPath = categoryIcons[categoryName] || '';
                    gridHTML += `
                        <div class="sheet-category-item" data-category="${categoryName}">
                            <img src="${iconPath}" alt="${categoryName}" class="sheet-category-icon">
                            <span class="sheet-category-name">${categoryName}</span>
                        </div>
                    `;
                });
                
                gridHTML += '</div>';
                
                return `
                    <div class="dropdown-category-header">
                        <button class="dropdown-category-back">‚Äπ</button>
                        <h3>Danh m·ª•c s·∫£n ph·∫©m</h3>
                    </div>
                    <div class="dropdown-category-content">
                        ${gridHTML}
                    </div>
                `;
            }
            
            // X·ª≠ l√Ω click tr√™n dropdown (event delegation)
            dropdownContent.addEventListener('click', function(e) {
                e.stopPropagation();
                
                // N·∫øu click v√†o "S·∫£n ph·∫©m" tr√™n mobile
                if (window.innerWidth <= 768 && e.target.classList.contains('has-submenu')) {
                    e.preventDefault();
                    dropdownContent.innerHTML = createCategoryHTML();
                    dropdownContent.style.display = 'block';
                }
                // N·∫øu click v√†o n√∫t back
                else if (e.target.classList.contains('dropdown-category-back')) {
                    dropdownContent.innerHTML = originalDropdownHTML;
                    dropdownContent.style.display = 'block';
                    // G·∫Øn l·∫°i s·ª± ki·ªán cho dropdown m·ªõi
                    setTimeout(attachDropdownEvents, 0);
                }
                // N·∫øu click v√†o m·ªôt nh√≥m s·∫£n ph·∫©m
                else if (e.target.closest('.sheet-category-item')) {
                    const categoryItem = e.target.closest('.sheet-category-item');
                    const categoryName = categoryItem.getAttribute('data-category');
                    // ƒê√≥ng dropdown
                    dropdownContent.style.display = 'none';
                    // TODO: C√≥ th·ªÉ th√™m chuy·ªÉn h∆∞·ªõng ƒë·∫øn trang danh m·ª•c
                    console.log('Ch·ªçn danh m·ª•c:', categoryName);
                }
                // N·∫øu click v√†o c√°c link kh√°c (Trang ch·ªß, Gi·ªõi thi·ªáu, ...)
                else if (e.target.tagName === 'A' && e.target.getAttribute('href') && e.target.getAttribute('href') !== '#') {
                    // ƒê√≥ng dropdown
                    dropdownContent.style.display = 'none';
                }
            });
            
            // H√†m g·∫Øn s·ª± ki·ªán cho dropdown
            function attachDropdownEvents() {
                // ƒê·∫£m b·∫£o dropdown hi·ªÉn th·ªã ƒë√∫ng tr√™n mobile
                if (window.innerWidth <= 768) {
                    dropdownContent.style.position = 'fixed';
                    dropdownContent.style.top = '100px';
                    dropdownContent.style.left = '10px';
                    dropdownContent.style.right = '10px';
                    dropdownContent.style.width = 'calc(100% - 20px)';
                }
            }
            
            // X·ª≠ l√Ω n√∫t "Danh m·ª•c"
            if (dropdownBtn) {
                dropdownBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    if (dropdownContent.style.display === 'block') {
                        dropdownContent.style.display = 'none';
                    } else {
                        // Reset v·ªÅ menu ch√≠nh khi m·ªü dropdown
                        if (window.innerWidth <= 768) {
                            dropdownContent.innerHTML = originalDropdownHTML;
                            attachDropdownEvents();
                        }
                        dropdownContent.style.display = 'block';
                    }
                });
            }
            
            // ƒê√≥ng dropdown khi click ra ngo√†i
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.dropdown') && !e.target.closest('.dropdown-content')) {
                    dropdownContent.style.display = 'none';
                }
            });
            
            // Kh·ªüi t·∫°o
            attachDropdownEvents();
            
            // X·ª≠ l√Ω khi resize window
            window.addEventListener('resize', function() {
                if (window.innerWidth > 768) {
                    dropdownContent.innerHTML = originalDropdownHTML;
                    dropdownContent.style.position = '';
                    dropdownContent.style.top = '';
                    dropdownContent.style.left = '';
                    dropdownContent.style.right = '';
                    dropdownContent.style.width = '';
                    dropdownContent.style.display = '';
                } else {
                    attachDropdownEvents();
                }
            });
        });
    </script>   
    <section class="quote-section">
        <div class="container">
            <div class="quote-background">
                <div class="quote-content">
                    <div class="quote-left">
                        <h2>ƒêƒÇNG K√ù T∆Ø V·∫§N</h2>
                        <p>Nh·∫≠n t∆∞ v·∫•n mi·ªÖn ph√≠ t·ª´ ƒë·ªôi ng≈© chuy√™n gia.</p>
                    </div>
                    <div class="quote-form">
                        <form>
                            <div class="form-row">
                                <input type="text" placeholder="H·ªç v√† t√™n *" required>
                                <input type="tel" placeholder="S·ªë ƒëi·ªán tho·∫°i *" required>
                            </div>
                            <input type="email" placeholder="Email">
                            <textarea placeholder="N·ªôi dung c·∫ßn t∆∞ v·∫•n..."></textarea>
                            <button type="submit" class="quote-btn">G·ª¨I TH√îNG TIN</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-column">
                    <h3>H·ªó tr·ª£ kh√°ch h√†ng</h3>
                    <ul>
                        <li>Hotline: 0937 043 808</li>
                        <li>(8-21h k·ªÉ c·∫£ T7, CN)</li>
                        <li>ƒêi·ªÅu kho·∫£n d·ªãch v·ª•</li>
                        <li>Ch√≠nh s√°ch ph·ª•c v·ª•</li>
                        <li>Ch√≠nh s√°ch ƒë·ªïi tr·∫£</li>
                        <li>Ch√≠nh s√°ch b·∫£o m·∫≠t</li>
                        <li>Ch√≠nh s√°ch v·∫≠n chuy·ªÉn</li>
                        <li>Ch√≠nh s√°ch thanh to√°n</li>
                        <li>Ch√≠nh s√°ch b·∫£o h√†nh</li>
                        <li>H·ªó tr·ª£ kh√°ch h√†ng: ducphuongmedical@gmail.com</li>
                    </ul>
                </div>
                
                <div class="footer-column">
                    <h3>B·∫£n tin s·ª©c kh·ªèe</h3>
                    <ul>
                        <li>Tin t·ª©c v·ªÅ gi∆∞·ªùng b·ªánh nh√¢n</li>
                        <li>H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng gi∆∞·ªùng b·ªánh</li>
                        <li>H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng xe lƒÉn ƒëi·ªán</li>
                        <li>Tin t·ª©c v·ªÅ m√°y t·∫°o Oxy</li>
                        <li>Tin t·ª©c v·ªÅ Xe LƒÉn</li>
                    </ul>
                    

                </div>
                
                <div class="footer-column">
                    <h3>Ph∆∞∆°ng th·ª©c thanh to√°n</h3>
                    <div class="payment-methods">
                        <img src="hinh-thanhtoan/visa.png" alt="Visa">
                        <img src="hinh-thanhtoan/mastercard.png" alt="Mastercard">
                        <img src="hinh-thanhtoan/jcb.png" alt="JCB">
                        <img src="hinh-thanhtoan/momo.png" alt="MoMo">
                    </div>
                    
                    <h4>D·ªãch v·ª• giao h√†ng</h4>
                    <div class="delivery-services">
                        <img src="hinh-anh/giao-hang.png" alt="Giao h√†ng">
                    </div>
                </div>
                
                <div class="footer-column">
                    <h3>K·∫øt n·ªëi v·ªõi ch√∫ng t√¥i</h3>
                    <div class="social-links">
                        <a href="https://www.facebook.com/ducphuongnguyenphuoctay" target="_blank">
                            <img src="hinh-anh/fb-logo.png" alt="Facebook">
                        </a>
                        <a href="https://youtube.com/@ducphuongmedical" target="_blank">
                            <img src="hinh-anh/youtube-icon.png" alt="YouTube">
                        </a>
                        <a href="https://zalo.me/0938.062.808" target="_blank">
                            <img src="hinh-anh/icon-zalo.png" alt="Zalo">
                        </a>
                        <a href="https://mail.google.com/mail/?view=cm&fs=1&to=ducphuongmedical@gmail.com" target="_blank">
                            <img src="hinh-anh/icon-gmail.png" alt="Gmail">
                        </a>
                    </div>
                    
                    <div class="certificates">
                        <h4>Ch·ª©ng nh·∫≠n b·ªüi</h4>
                        <div class="cert-logos">
                            <img src="hinh-anh/icon-ddk.png" alt="ƒê√£ ƒëƒÉng k√Ω">
                        </div>
                    </div>
                    

                </div>
            </div>
            
            <div class="footer-bottom">
                <div class="footer-bottom-content">
                    <div class="company-info">
                        <p>ƒê·ªãa ch·ªâ: 12 ƒê√¥ng H·ªì, Ph∆∞·ªùng 08, Qu·∫≠n T√¢n B√¨nh, TP.HCM</p>
                        <p>TaJerMy nh·∫≠n ƒë·∫∑t h√†ng tr·ª±c tuy·∫øn v√† giao h√†ng t·∫≠n n∆°i ho·∫∑c mua h√†ng tr·ª±c ti·∫øp t·∫°i c·ª≠a h√†ng</p>
                        <p>Gi·∫•y ch·ª©ng nh·∫≠n ƒêƒÉng k√Ω Kinh doanh s·ªë 0313717853 do S·ªü K·∫ø ho·∫°ch v√† ƒê·∫ßu t∆∞ Th√†nh ph·ªë H·ªì Ch√≠ Minh c·∫•p ng√†y 25/03/2016</p>
                        <p>&copy; 2022 - B·∫£n quy·ªÅn c·ªßa TaJerMy - www.ducphuongmedical.com. C·∫•m sao ch√©p d∆∞·ªõi m·ªçi h√¨nh th·ª©c n·∫øu kh√¥ng c√≥ s·ª± ch·∫•p thu·∫≠n b·∫±ng vƒÉn b·∫£n.</p>
                    </div>
                </div>
            </div>
        </div>
    </footer>
    <div class="phone-contact">
        <button class="admin-edit-btn" style="position: absolute; right: 70px; top: 15px;" onclick="openLinkEditModal('phone', this)">‚úèÔ∏è S·ª≠a</button>
        <a href="tel:0938062808" data-uid="contact-phone">
            <img src="hinh-anh/icon-dt.png" alt="ƒêi·ªán tho·∫°i">
        </a>
    </div>
    <div class="cskh-contact" onclick="toggleChat()">
        <img src="hinh-anh/icon-cskh.png" alt="CSKH">
        <span id="cskhBadge" style="display:none; position:absolute; top:-8px; right:-8px; background:#dc3545; color:#fff; border-radius:12px; padding:0 6px; font-size:12px; line-height:20px; min-width:20px; text-align:center;">0</span>
    </div>
        <style>
            /* ·∫®n n√∫t ch·ªânh s·ª≠a tr√™n n√∫t CSKH */
            .cskh-contact .admin-edit-btn { display: none !important; }
        
            .admin-chat-send {
                padding: 6px 15px;
                min-width: 5px;
                font-size: 15px;
                border-radius: 8px;
                color: #fff;
            }
            
            /* Customer avatar clickable */
            .customer-avatar-clickable {
                cursor: pointer;
                transition: transform 0.2s;
            }
            .customer-avatar-clickable:hover {
                transform: scale(1.1);
            }
        </style>
    <div class="zalo-contact">
        <button class="admin-edit-btn" style="position: absolute; right: 70px; top: 15px;" onclick="openLinkEditModal('zalo', this)">‚úèÔ∏è S·ª≠a</button>
        <a href="https://zalo.me/0938.062.808" target="_blank" data-uid="contact-zalo">
            <img src="hinh-anh/icon-zalo.png" alt="Zalo">
        </a>
    </div>
    <div class="youtube-contact">
        <button class="admin-edit-btn" style="position: absolute; right: 70px; top: 15px;" onclick="openLinkEditModal('youtube', this)">‚úèÔ∏è S·ª≠a</button>
        <a href="https://www.youtube.com/@ducphuongmedical" target="_blank" data-uid="contact-youtube">
            <img src="hinh-anh/youtube-icon.png" alt="YouTube">
        </a>
    </div>
    <div class="facebook-contact">
        <button class="admin-edit-btn" style="position: absolute; right: 70px; top: 15px;" onclick="openLinkEditModal('facebook', this)">‚úèÔ∏è S·ª≠a</button>
        <a href="https://www.facebook.com/ducphuongnguyenphuoctay" target="_blank" data-uid="contact-facebook">
            <img src="hinh-anh/fb-logo.png" alt="Facebook">
        </a>
    </div>
    
    <div class="chat-box" id="chatBox" style="display:none; position:fixed; right:20px; bottom:80px; width:820px; max-width:95vw; height:520px; max-height:70vh; background:#fff; border:1px solid #e5e7eb; border-radius:12px; box-shadow:0 8px 24px rgba(0,0,0,0.15); overflow:hidden; flex-direction:row;">
        <div class="chat-sidebar" style="width:280px; border-right:1px solid #eee; display:flex; flex-direction:column;">
            <div style="padding:10px; border-bottom:1px solid #eee; display:flex; gap:8px; align-items:center;">
                <input id="chatSearch" type="text" placeholder="T√¨m kh√°ch h√†ng..." style="flex:1; padding:8px 10px; border:1px solid #ddd; border-radius:8px;">
                <select id="chatFilter" style="padding:8px; border:1px solid #ddd; border-radius:8px;">
                    <option value="all">T·∫•t c·∫£</option>
                    <option value="unanswered">Ch∆∞a tr·∫£ l·ªùi</option>
                    <option value="new">C√≥ tin m·ªõi</option>
                </select>
            </div>
            <div id="chatList" style="flex:1; overflow:auto;">
                <!-- Conversations will render here -->
            </div>
        </div>
        <div class="chat-main" style="flex:1; display:flex; flex-direction:column;">
            <div class="chat-header" style="display:flex; align-items:center; gap:10px; padding:10px; border-bottom:1px solid #eee;">
                <div id="peerAvatarWrap" style="width:36px; height:36px; border-radius:50%; overflow:hidden; background:#f3f4f6;"></div>
                <div style="flex:1;">
                    <div id="peerName" style="font-weight:600;">Ch∆∞a ch·ªçn kh√°ch h√†ng</div>
                    <div id="peerStatus" style="font-size:12px; color:#6b7280;">Tr·∫°ng th√°i: -</div>
                </div>
                <button onclick="exportConversation()" class="admin-chat-send" style="background:#28a745">Xu·∫•t h·ªôi tho·∫°i</button>
                <button onclick="toggleChat()" class="admin-chat-send" style="background:#dc3545">ƒê√≥ng</button>
            </div>
            <div id="peerInfo" style="padding:8px 12px; border-bottom:1px solid #f3f4f6; font-size:12px; color:#374151; display:none"></div>
            <div id="chatThread" style="flex:1; overflow:auto; background:#fafafa; padding:10px 0;">
                <!-- Messages -->
            </div>
            <div id="typingIndicator" style="padding:6px 12px; font-size:12px; color:#6b7280; display:none">ƒêang nh·∫≠p...</div>
            <div class="chat-composer" style="display:flex; gap:8px; padding:10px; border-top:1px solid #eee; background:#fff; align-items:center;">
                <input type="text" id="chatInput" placeholder="Nh·∫≠p tin nh·∫Øn..." style="flex:1; padding:10px; border:1px solid #ddd; border-radius:8px;">
                <input type="file" id="chatFile" style="display:none">
                <button onclick="openFilePicker()" class="continue-btn" style="width:42px; height:42px; min-width:42px; padding:0; display:flex; align-items:center; justify-content:center; background:#f1f5f9; border:1px solid #e5e7eb;">
                    <img src="hinh-anh/icon-file.png" alt="T·ªáp" style="width:20px; height:20px; object-fit:contain;">
                </button>
                <button onclick="sendChatMessage()" class=" admin-chat-send" style="background:#0d6efd;">G·ª≠i</button>
            </div>
        </div>
    </div>
    
    <!-- Certificate Modal -->
    <div id="certModal" class="cert-modal">
        <div class="cert-modal-content">
            <span class="cert-close" onclick="closeCertModal()">&times;</span>
            <img id="certModalImg" src="" alt="">
        </div>
    </div>
    
    <!-- Customer Info Modal -->
    <div id="customerInfoModal" class="modal" style="display:none; z-index:10000;">
        <div class="modal-content" style="max-width:500px;">
            <span class="close" onclick="closeCustomerInfoModal()">&times;</span>
            <h2 style="margin-top:0; color:#333;">Th√¥ng tin kh√°ch h√†ng</h2>
            <div id="customerInfoContent" style="padding:10px 0;">
                <div style="text-align:center; margin-bottom:20px;">
                    <div id="customerAvatar" style="width:80px; height:80px; border-radius:50%; margin:0 auto; background:#e5e7eb;"></div>
                </div>
                <div style="line-height:1.8;">
                    <p><strong>T√™n:</strong> <span id="customerName">-</span></p>
                    <p><strong>Email:</strong> <span id="customerEmail">-</span></p>
                    <p><strong>S·ªë ƒëi·ªán tho·∫°i:</strong> <span id="customerPhone">-</span></p>
                    <p><strong>ID:</strong> <span id="customerId">-</span></p>
                    <p><strong>Ng√†y ƒëƒÉng k√Ω:</strong> <span id="customerCreated">-</span></p>
                </div>
            </div>
        </div>
    </div>
    
    <script>
    // ===== CSKH Admin Panel Logic (Two-way Chat) =====
    (function(){
        const chatBox = document.getElementById('chatBox');
        const badge = document.getElementById('cskhBadge');
        const chatList = document.getElementById('chatList');
        const chatThread = document.getElementById('chatThread');
        const chatInput = document.getElementById('chatInput');
        const chatFile = document.getElementById('chatFile');
        const peerInfo = document.getElementById('peerInfo');
        const peerName = document.getElementById('peerName');
        const peerStatus = document.getElementById('peerStatus');
        const peerAvatarWrap = document.getElementById('peerAvatarWrap');
        const typingIndicator = document.getElementById('typingIndicator');
        let currentPeerId = null;

        function api(action, payload){
            if (action === 'export') {
                window.open('messages.php?action=export', '_blank');
                return Promise.resolve();
            }
            const body = payload ? JSON.stringify(Object.assign({action}, payload)) : JSON.stringify({action});
            return fetch('/messages.php', { method: 'POST', headers: {'Content-Type':'application/json'}, body })
                .then(r=>r.json());
        }

        function fmtTime(t){
            try { const d = new Date(t); return d.toLocaleString('vi-VN'); } catch { return t; }
        }

        let convData = [];
        function renderConversations(items){
            convData = items.slice();
            const q = (document.getElementById('chatSearch').value||'').toLowerCase();
            const filter = document.getElementById('chatFilter').value||'all';
            chatList.innerHTML = '';
            items.filter(it => {
                const nameMatch = (it.peer_username||'').toLowerCase().includes(q);
                let pass = nameMatch;
                if (filter==='new') pass = pass && (it.unread_count||0)>0;
                if (filter==='unanswered') pass = pass && (!it.last_content || it.last_content.trim().length===0);
                return pass;
            }).forEach(it => {
                const row = document.createElement('div');
                row.className = 'chat-row';
                row.style.display = 'grid';
                row.style.gridTemplateColumns = '40px 1fr auto';
                row.style.gap = '10px';
                row.style.padding = '10px';
                row.style.borderBottom = '1px solid #f3f4f6';
                row.style.cursor = 'pointer';

                const avatar = document.createElement('div');
                avatar.style.width='40px'; avatar.style.height='40px'; avatar.style.borderRadius='50%'; avatar.style.background='#e5e7eb';
                avatar.className = 'customer-avatar-clickable';
                if (it.peer_avatar) { avatar.style.backgroundImage = `url(${it.peer_avatar})`; avatar.style.backgroundSize='cover'; }
                avatar.addEventListener('click', (e) => { e.stopPropagation(); showCustomerInfo(it.peer_id); });

                const mid = document.createElement('div');
                const name = document.createElement('div'); name.textContent = it.peer_username || ('ID:'+it.peer_id); name.style.fontWeight='600';
                const snippet = document.createElement('div'); snippet.textContent = (it.last_content||''); snippet.style.color='#6b7280'; snippet.style.fontSize='12px';
                mid.appendChild(name); mid.appendChild(snippet);

                const right = document.createElement('div'); right.style.textAlign='right';
                const time = document.createElement('div'); time.textContent = fmtTime(it.last_time); time.style.fontSize='12px'; time.style.color='#6b7280';
                const badgeEl = document.createElement('span'); if ((it.unread_count||0)>0){ badgeEl.textContent = it.unread_count; badgeEl.style.display='inline-block'; badgeEl.style.background='#dc3545'; badgeEl.style.color='#fff'; badgeEl.style.borderRadius='12px'; badgeEl.style.padding='0 6px'; badgeEl.style.fontSize='12px'; }
                right.appendChild(time); right.appendChild(badgeEl);

                row.appendChild(avatar); row.appendChild(mid); row.appendChild(right);
                row.addEventListener('click', () => selectConversation(it.peer_id, it));
                chatList.appendChild(row);
            });
        }

        function selectConversation(peerId, meta){
            currentPeerId = peerId;
            peerName.textContent = meta.peer_username || ('ID:'+peerId);
            peerStatus.textContent = 'Tr·∫°ng th√°i: ƒëang c·∫≠p nh·∫≠t...';
            peerAvatarWrap.innerHTML = meta.peer_avatar ? `<img src="${meta.peer_avatar}" style="width:100%;height:100%;object-fit:cover">` : '';
            peerInfo.style.display = 'block';
            peerInfo.innerHTML = `Email: - ‚Ä¢ SƒêT: -`;
            loadMessages(peerId).then(()=> api('mark_read_conversation',{peer_id:peerId}).then(poll));
        }

        function renderMessageBubble(m){
            const isAdminSide = (m.sender_id === 0);
            const wrap = document.createElement('div');
            wrap.style.display='flex'; wrap.style.padding='4px 12px'; wrap.style.justifyContent = isAdminSide ? 'flex-end' : 'flex-start';
            const bubble = document.createElement('div');
            bubble.style.maxWidth='70%'; bubble.style.padding='8px 10px'; bubble.style.borderRadius='12px';
            bubble.style.background = isAdminSide ? '#dbeafe' : '#fff'; bubble.style.border = '1px solid #e5e7eb';
            bubble.innerHTML = m.is_recalled ? '<em>Tin nh·∫Øn ƒë√£ ƒë∆∞·ª£c thu h·ªìi</em>' : (m.message_type==='text' ? (m.content||'') : (m.message_type==='image' ? `<img src="${m.attachment_path}" style="max-width:100%">` : (m.message_type==='file' ? `<a href="${m.attachment_path}" target="_blank">T·∫≠p tin</a>` : (m.message_type==='emoji' ? m.content : m.content))));
            bubble.style.position = 'relative';
            // Recall control on hover for admin's own message if eligible
            if (isAdminSide && !m.is_recalled) {
                const ageMs = Math.max(0, Date.now() - new Date(m.created_at).getTime());
                const eligible = (m.status !== 'read') && (ageMs < 180000);
                if (eligible) {
                    const recallEl = document.createElement('button');
                    recallEl.textContent = 'Thu h·ªìi';
                    recallEl.style.position = 'absolute';
                    recallEl.style.right = '8px';
                    recallEl.style.top = '-18px';
                    recallEl.style.background = '#fd7e14';
                    recallEl.style.color = '#fff';
                    recallEl.style.border = 'none';
                    recallEl.style.borderRadius = '10px';
                    recallEl.style.padding = '2px 8px';
                    recallEl.style.fontSize = '11px';
                    recallEl.style.cursor = 'pointer';
                    recallEl.style.display = 'none';
                    recallEl.addEventListener('click', function(e){ e.stopPropagation(); api('recall_message',{id:m.id}).then(r=>{ if (r.status==='success'){ loadMessages(currentPeerId); } else { alert(r.message||'Kh√¥ng th·ªÉ thu h·ªìi'); } }); });
                    bubble.addEventListener('mouseenter', ()=> recallEl.style.display = 'inline-block');
                    bubble.addEventListener('mouseleave', ()=> recallEl.style.display = 'none');
                    bubble.appendChild(recallEl);
                }
            }
            const time = document.createElement('div');
            const ticks = (m.status==='read') ? '‚úì‚úì' : '‚úì';
            time.textContent = fmtTime(m.created_at) + (isAdminSide ? (' ‚Ä¢ ' + ticks) : '');
            time.style.fontSize='11px'; time.style.color='#6b7280'; time.style.marginTop='4px';
            bubble.appendChild(time);
            wrap.appendChild(bubble);
            return wrap;
        }

        function renderThread(list){
            chatThread.innerHTML='';
            list.forEach(m => chatThread.appendChild(renderMessageBubble(m)));
            chatThread.scrollTop = chatThread.scrollHeight;
        }

        function loadConversations(){ return api('list_conversations').then(d => { if (d.status==='success') renderConversations(d.conversations||[]); }); }
        function loadMessages(peerId){ return api('list_messages',{peer_id:peerId, limit:500}).then(d => { if (d.status==='success') renderThread(d.messages||[]); }); }

        function updateBadge(count){
            if (!badge) return;
            if (count > 0) { badge.textContent = count; badge.style.display = 'inline-block'; }
            else { badge.style.display = 'none'; }
        }

        function poll(){
            api('unread_count').then(d => { const c = (d && d.status==='success') ? (d.count||0) : 0; updateBadge(c); });
            loadConversations();
            if (currentPeerId) { loadMessages(currentPeerId); }
        }

        window.openFilePicker = function(){ chatFile.click(); };
        // Emoji removed as requested
        window.sendChatMessage = function(){
            if (!currentPeerId) { alert('Vui l√≤ng ch·ªçn kh√°ch h√†ng ƒë·ªÉ chat.'); return; }
            const text = (chatInput.value||'').trim();
            const file = chatFile.files && chatFile.files[0];
            if (!text && !file) { return; }
            if (file) {
                const fd = new FormData();
                fd.append('file', file);
                fetch('/upload_chat_attachment.php', { method:'POST', body: fd }).then(r=>r.json()).then(res=>{
                    if (res.status==='success') {
                        return api('send', { receiver_id: currentPeerId, message_type: 'image', attachment_path: res.path, content: '' });
                    } else { throw new Error('Upload th·∫•t b·∫°i'); }
                }).then(()=>{ chatFile.value=''; loadMessages(currentPeerId); try { if (ws && ws.readyState===1) { ws.send(JSON.stringify({type:'message', from:0, to:currentPeerId })); } } catch {} }).catch(()=> alert('Kh√¥ng th·ªÉ g·ª≠i t·ªáp.'));
            } else {
                api('send', { receiver_id: currentPeerId, message_type:'text', content:text }).then(d=>{
                    if (d.status==='success') { chatInput.value=''; loadMessages(currentPeerId); try { if (ws && ws.readyState===1) { ws.send(JSON.stringify({type:'message', from:0, to:currentPeerId })); } } catch {} }
                });
            }
        };

        // Recall now handled per-message hover

        // Typing indicator via WebSocket
        let typingTimer = null;
        if (chatInput) {
            chatInput.addEventListener('input', function(){
                if (!currentPeerId || !ws || ws.readyState !== 1) return;
                try { ws.send(JSON.stringify({type:'typing', from:0, to: currentPeerId, active:true })); } catch {}
                if (typingTimer) clearTimeout(typingTimer);
                typingTimer = setTimeout(function(){ try { ws.send(JSON.stringify({type:'typing', from:0, to: currentPeerId, active:false })); } catch {} }, 1500);
            });
        }

        window.exportConversation = function(){
            // TODO: implement per-conversation export; for now export all customer messages
            window.open('messages.php?action=export', '_blank');
        };

        // Override toggleChat to open/close and init data
        window.toggleChat = function(){
            if (!chatBox) return;
            const show = chatBox.style.display === 'none' || chatBox.style.display === '';
            chatBox.style.display = show ? 'flex' : 'none';
            if (show) { loadConversations(); if (currentPeerId) loadMessages(currentPeerId); }
        };

        // Remove any edit button over CSKH icon
        document.querySelectorAll('.cskh-contact .admin-edit-btn').forEach(el => el.remove());

        // WebSocket integration for real-time
        let ws;
        function connectWS(){
            try {
                ws = new WebSocket('ws://localhost:9000');
                ws.onopen = function(){
                    // Admin identity (id 0)
                    ws.send(JSON.stringify({type:'hello', sender_id:0, username:'Admin', role:'admin'}));
                };
                ws.onmessage = function(ev){
                    let msg = {}; try { msg = JSON.parse(ev.data); } catch { return; }
                    if (msg.type === 'message' && msg.to === 0) {
                        // New customer message to admin
                        if (chatBox && chatBox.style.display !== 'none') {
                            if (currentPeerId && currentPeerId === msg.from) { loadMessages(currentPeerId); }
                        }
                        poll();
                    }
                    if (msg.type === 'typing' && currentPeerId && msg.from === currentPeerId) {
                        typingIndicator.style.display = msg.active ? 'block' : 'none';
                    }
                    if (msg.type === 'presence' && currentPeerId && msg.sender_id === currentPeerId) {
                        peerStatus.textContent = 'Tr·∫°ng th√°i: ' + (msg.online ? 'Online' : 'Offline');
                    }
                };
            } catch (e) { /* ignore */ }
        }

        // Search & filter handlers
        const chatSearch = document.getElementById('chatSearch');
        const chatFilter = document.getElementById('chatFilter');
        chatSearch && chatSearch.addEventListener('input', () => renderConversations(convData));
        chatFilter && chatFilter.addEventListener('change', () => renderConversations(convData));

        // Start polling and WebSocket
        setInterval(poll, 8000);
        poll();
        connectWS();
    })();
    
    // Customer Info Modal Functions
    function showCustomerInfo(userId) {
        const modal = document.getElementById('customerInfoModal');
        modal.style.display = 'block';
        
        // Fetch customer info from messages.php with get_user_info action
        console.log('Fetching user info for ID:', userId);
        fetch(`messages.php?action=get_user_info&user_id=${userId}`)
        .then(r => {
            console.log('Response status:', r.status);
            return r.text();
        })
        .then(text => {
            console.log('Response text:', text);
            try {
                const data = JSON.parse(text);
                if (data.status === 'success' && data.user) {
                    const user = data.user;
                    document.getElementById('customerName').textContent = user.username || '-';
                    document.getElementById('customerEmail').textContent = user.gmail || '-';
                    document.getElementById('customerPhone').textContent = user.phone || '-';
                    document.getElementById('customerId').textContent = user.id || '-';
                    document.getElementById('customerCreated').textContent = user.created_at ? new Date(user.created_at).toLocaleString('vi-VN') : '-';
                    
                    const avatarDiv = document.getElementById('customerAvatar');
                    if (user.avatar_path) {
                        avatarDiv.style.backgroundImage = `url(${user.avatar_path})`;
                        avatarDiv.style.backgroundSize = 'cover';
                        avatarDiv.style.backgroundPosition = 'center';
                    } else {
                        avatarDiv.style.backgroundImage = 'none';
                    }
                } else {
                    console.error('API response:', data);
                    alert('Kh√¥ng th·ªÉ t·∫£i th√¥ng tin kh√°ch h√†ng: ' + (data.message || 'L·ªói kh√¥ng x√°c ƒë·ªãnh'));
                }
            } catch (e) {
                console.error('JSON parse error:', e);
                alert('L·ªói ph√¢n t√≠ch d·ªØ li·ªáu: ' + text.substring(0, 100));
            }
        })
        .catch(err => {
            console.error('Fetch error:', err);
            alert('L·ªói khi t·∫£i th√¥ng tin kh√°ch h√†ng: ' + err.message);
        });
    }
    
    function closeCustomerInfoModal() {
        document.getElementById('customerInfoModal').style.display = 'none';
    }
    
    // Close modal when clicking outside
    window.addEventListener('click', function(event) {
        const modal = document.getElementById('customerInfoModal');
        if (event.target === modal) {
            closeCustomerInfoModal();
        }
    });
    </script>
    <!-- Modal Ch·ªânh s·ª≠a H√¨nh ·∫£nh -->
    <div id="imageEditModal" class="modal">
        <div class="modal-content image-edit-modal-content">
            <span class="close" onclick="closeImageEditModal()">&times;</span>
            <h2>Ch·ªânh s·ª≠a H√¨nh ·∫£nh</h2>
            
            <label for="imageFileInput">Ch·ªçn file t·ª´ m√°y t√≠nh</label>
            <input type="file" id="imageFileInput" accept="image/*" onchange="autoSelectExtension(); updatePathPreview();">
            
            <label for="imageFolderSelect">Th∆∞ m·ª•c l∆∞u tr·ªØ</label>
            <select id="imageFolderSelect" class="login-input" onchange="updatePathPreview()">
                <option value="hinh-anh/">hinh-anh/</option>
                <option value="hinh-san-pham/">hinh-san-pham/</option>
                <option value="hinh-du-an/">hinh-du-an/</option>
                <option value="hinh-chung-nhan/">hinh-chung-nhan/</option>
                <option value="hinh-trien-lam/">hinh-trien-lam/</option>
                <option value="hinh-xuong/">hinh-xuong/</option>
                <option value="hinh-thongtin/">hinh-thongtin/</option>
                <option value="custom">T√πy ch·ªânh...</option>
            </select>
            
            <div id="customFolderDiv" style="display: none; margin-top: 10px;">
                <label for="customFolderInput">ƒê∆∞·ªùng d·∫´n t√πy ch·ªânh</label>
                <input type="text" id="customFolderInput" class="login-input" placeholder="V√≠ d·ª•: uploads/images/" onchange="updatePathPreview()">
            </div>
            
            <label for="imageNameInput">T√™n file</label>
            <input type="text" id="imageNameInput" placeholder="Nh·∫≠p t√™n file (kh√¥ng c·∫ßn ƒëu√¥i)" onchange="updatePathPreview()">
            
            <label for="imageExtSelect">ƒêu√¥i file</label>
            <select id="imageExtSelect" class="login-input" onchange="updatePathPreview()">
                <option value=".jpg">.jpg</option>
                <option value=".jpeg">.jpeg</option>
                <option value=".png">.png</option>
                <option value=".gif">.gif</option>
                <option value=".webp">.webp</option>
                <option value=".svg">.svg</option>
                <option value=".bmp">.bmp</option>
            </select>
            
            <div id="pathPreview" style="margin-top: 10px; padding: 10px; background: #f0f0f0; border-radius: 5px; display: none;">
                <strong>File s·∫Ω ƒë∆∞·ª£c l∆∞u t·∫°i:</strong> <span id="pathPreviewText"></span>
            </div>
            
            <button class="continue-btn" onclick="uploadImage()" style="margin-top: 20px;">T·∫£i l√™n</button>
            
            <div id="progressContainer" class="progress-bar-container">
                <div id="uploadProgressBar" class="progress-bar">0%</div>
            </div>
            
            <button id="updateImageBtn" class="continue-btn" onclick="updateImage()" style="display: none;">C·∫≠p nh·∫≠t</button>
        </div>
    </div>
    
    <!-- Modal Ch·ªânh s·ª≠a VƒÉn b·∫£n -->
    <div id="textEditModal" class="modal">
        <div class="modal-content image-edit-modal-content">
            <span class="close" onclick="closeTextEditModal()">&times;</span>
            <h2>Ch·ªânh s·ª≠a VƒÉn b·∫£n</h2>
            
            <label for="textEditInput">N·ªôi dung vƒÉn b·∫£n</label>
            <textarea id="textEditInput" class="login-input" style="height: 100px; font-family: inherit;"></textarea>
            
            <button class="continue-btn" onclick="updateText()" style="margin-top: 20px; background-color: #28a745;">C·∫≠p nh·∫≠t</button>
        </div>
    </div>

    <!-- Modal Ch·ªânh s·ª≠a Li√™n k·∫øt -->
    <div id="linkEditModal" class="modal">
        <div class="modal-content image-edit-modal-content">
            <span class="close" onclick="closeLinkEditModal()">&times;</span>
            <h2 id="linkEditTitle">Ch·ªânh s·ª≠a Li√™n k·∫øt</h2>
            
            <label id="linkEditLabel" for="linkEditInput">Li√™n k·∫øt m·ªõi</label>
            <input type="text" id="linkEditInput" class="login-input">
            
            <button class="continue-btn" onclick="updateLink()" style="margin-top: 20px; background-color: #28a745;">C·∫≠p nh·∫≠t</button>
        </div>
    </div>

    <!-- Mobile Category Bottom Sheet -->
    <div class="sheet-overlay" id="sheetOverlay" onclick="closeMobileCategorySheet()"></div>
    <div class="mobile-category-sheet" id="mobileCategorySheet">
        <div class="sheet-header">
            <h3>Danh m·ª•c s·∫£n ph·∫©m</h3>
            <span class="sheet-close" onclick="closeMobileCategorySheet()">&times;</span>
        </div>
        <div class="sheet-content" id="sheetContent">
            <!-- Content will be populated by JavaScript -->
        </div>
    </div>
    
    <script>
        function openCertModal(imgSrc, altText) {
            const modal = document.getElementById('certModal');
            const modalImg = document.getElementById('certModalImg');
            modal.style.display = 'flex';
            modalImg.src = imgSrc;
            modalImg.alt = altText;
        }

        // M·ªü modal v√† reset tr·∫°ng th√°i
        function openImageEditModal(imgElement) {
            currentEditingImage = imgElement;
            const modal = document.getElementById('imageEditModal');
            
            // Reset form
            document.getElementById('imageFileInput').value = '';
            document.getElementById('imageNameInput').value = '';
            document.getElementById('progressContainer').style.display = 'none';
            document.getElementById('uploadProgressBar').style.width = '0%';
            document.getElementById('uploadProgressBar').innerText = '0%';
            document.getElementById('updateImageBtn').style.display = 'none';
            document.getElementById('pathPreview').style.display = 'none';
            document.getElementById('customFolderDiv').style.display = 'none';
            document.getElementById('updateImageBtn').removeAttribute('data-uploaded-path');
            
            // Reset progress bar color
            document.getElementById('uploadProgressBar').style.backgroundColor = '#4CAF50';
            
            // Load recent paths history
            loadRecentPaths();
            
            // Set default folder and extension
            document.getElementById('imageFolderSelect').value = 'hinh-anh/';
            document.getElementById('imageExtSelect').value = '.jpg';
            
            modal.style.display = 'block';
        }

        // ƒê√≥ng modal
        function closeImageEditModal() {
            document.getElementById('imageEditModal').style.display = 'none';
            currentEditingImage = null;
        }

        // Gi·∫£ l·∫≠p qu√° tr√¨nh t·∫£i l√™n
        function uploadImage() {
            const fileInput = document.getElementById('imageFileInput');
            if (fileInput.files.length === 0) {
                alert('Vui l√≤ng ch·ªçn m·ªôt file ƒë·ªÉ t·∫£i l√™n.');
                return;
            }
            
            // Validate path
            const fullPath = getFullPath();
            if (!validatePath(fullPath, true)) {
                return;
            }

            const progressContainer = document.getElementById('progressContainer');
            const progressBar = document.getElementById('uploadProgressBar');
            const updateBtn = document.getElementById('updateImageBtn');
            
            progressContainer.style.display = 'block';
            updateBtn.style.display = 'none';
            
            // T·∫°o FormData ƒë·ªÉ g·ª≠i file
            const formData = new FormData();
            formData.append('image', fileInput.files[0]);
            formData.append('folderPath', getFolderPath());
            formData.append('fileName', getFullPath().split('/').pop()); // L·∫•y t√™n file t·ª´ ƒë∆∞·ªùng d·∫´n ƒë·∫ßy ƒë·ªß
            
            // G·ª≠i file l√™n server
            const xhr = new XMLHttpRequest();
            
            // Theo d√µi ti·∫øn tr√¨nh upload
            xhr.upload.addEventListener('progress', function(e) {
                if (e.lengthComputable) {
                    const percentComplete = Math.round((e.loaded / e.total) * 100);
                    progressBar.style.width = percentComplete + '%';
                    progressBar.innerText = percentComplete + '%';
                }
            });
            
            // X·ª≠ l√Ω khi upload ho√†n t·∫•t
            xhr.addEventListener('load', function() {
                if (xhr.status === 200) {
                    try {
                        const response = JSON.parse(xhr.responseText);
                        if (response.status === 'success') {
                            progressBar.innerText = 'ƒê√£ l∆∞u file t·∫°i: ' + response.path;
                            updateBtn.style.display = 'block';
                            
                            // L∆∞u ƒë∆∞·ªùng d·∫´n ƒë·ªÉ s·ª≠ d·ª•ng khi c·∫≠p nh·∫≠t
                            updateBtn.setAttribute('data-uploaded-path', response.path);
                            
                            // Save to recent paths history
                            saveToRecentPaths(getFolderPath());
                        } else {
                            progressBar.innerText = 'L·ªói: ' + response.message;
                            progressBar.style.backgroundColor = '#dc3545';
                        }
                    } catch (e) {
                        progressBar.innerText = 'L·ªói x·ª≠ l√Ω ph·∫£n h·ªìi t·ª´ server';
                        progressBar.style.backgroundColor = '#dc3545';
                    }
                } else {
                    progressBar.innerText = 'L·ªói upload: ' + xhr.status;
                    progressBar.style.backgroundColor = '#dc3545';
                }
            });
            
            // X·ª≠ l√Ω l·ªói
            xhr.addEventListener('error', function() {
                progressBar.innerText = 'L·ªói k·∫øt n·ªëi ƒë·∫øn server';
                progressBar.style.backgroundColor = '#dc3545';
            });
            
            // G·ª≠i request
            xhr.open('POST', 'upload_image.php', true);
            xhr.send(formData);
        }

        // H√†m l∆∞u v√†o localStorage
        function saveContent(uid, value) {
            const savedData = JSON.parse(localStorage.getItem('siteContent') || '{}');
            savedData[uid] = value;
            localStorage.setItem('siteContent', JSON.stringify(savedData));
            
            // Dispatch event ƒë·ªÉ c√°c tab kh√°c (nh∆∞ index.html ƒëang m·ªü) c√≥ th·ªÉ c·∫≠p nh·∫≠t ngay l·∫≠p t·ª©c
            window.dispatchEvent(new StorageEvent('storage', { key: 'siteContent', newValue: JSON.stringify(savedData) }));
        }

        // X·ª≠ l√Ω khi nh·∫•n n√∫t C·∫≠p nh·∫≠t
        function updateImage() {
            if (currentEditingImage) {
                const updateBtn = document.getElementById('updateImageBtn');
                const uploadedPath = updateBtn.getAttribute('data-uploaded-path');
                
                if (!uploadedPath) {
                    alert('Vui l√≤ng t·∫£i file l√™n tr∆∞·ªõc khi c·∫≠p nh·∫≠t!');
                    return;
                }
                
                // C·∫≠p nh·∫≠t src c·ªßa ·∫£nh ƒëang s·ª≠a v·ªõi ƒë∆∞·ªùng d·∫´n th·ª±c t·ª´ server
                currentEditingImage.src = uploadedPath;
                
                // L∆∞u v√†o localStorage ƒë·ªÉ index.html c·∫≠p nh·∫≠t
                const uid = currentEditingImage.getAttribute('data-uid');
                if(uid) {
                    saveContent(uid, uploadedPath);
                }
                
                alert('ƒê√£ c·∫≠p nh·∫≠t h√¨nh ·∫£nh th√†nh c√¥ng!\nƒê∆∞·ªùng d·∫´n: ' + uploadedPath + '\n\n·∫¢nh ƒë√£ ƒë∆∞·ª£c l∆∞u tr√™n server v√† s·∫Ω hi·ªÉn th·ªã tr√™n c·∫£ 2 trang.');
                
                closeImageEditModal();
                
                // Reload ƒë·ªÉ hi·ªÉn th·ªã ·∫£nh m·ªõi
                setTimeout(() => {
                    location.reload();
                }, 500);
            }
        }

        // --- X·ª≠ l√Ω VƒÉn b·∫£n ---
        function openTextEditModal(textElement) {
            currentEditingText = textElement;
            const modal = document.getElementById('textEditModal');
            
            // Clone ph·∫ßn t·ª≠ ƒë·ªÉ l·∫•y text an to√†n m√† kh√¥ng c√≥ n√∫t "s·ª≠a"
            const clone = textElement.cloneNode(true);
            const btnInClone = clone.querySelector('.admin-edit-btn');
            if (btnInClone) {
                clone.removeChild(btnInClone);
            }
            const content = clone.innerText.trim();
            
            document.getElementById('textEditInput').value = content;
            modal.style.display = 'block';
        }

        function closeTextEditModal() {
            document.getElementById('textEditModal').style.display = 'none';
            currentEditingText = null;
        }

        function updateText() {
            if (currentEditingText) {
                const newText = document.getElementById('textEditInput').value;
                const uid = currentEditingText.getAttribute('data-uid');
                
                // T√¨m n√∫t s·ª≠a ƒë·ªÉ c√≥ th·ªÉ th√™m l·∫°i sau khi c·∫≠p nh·∫≠t innerText
                const editBtn = currentEditingText.querySelector('.admin-edit-btn');
                // C·∫≠p nh·∫≠t n·ªôi dung vƒÉn b·∫£n. Thao t√°c n√†y s·∫Ω x√≥a n√∫t "s·ª≠a" kh·ªèi DOM.
                currentEditingText.innerText = newText; 
                // Th√™m l·∫°i n√∫t "s·ª≠a" v√†o cu·ªëi
                if (editBtn) {
                    currentEditingText.appendChild(editBtn);
                }

                // L∆∞u v√†o localStorage
                if(uid) saveContent(uid, newText);

                alert('ƒê√£ c·∫≠p nh·∫≠t vƒÉn b·∫£n th√†nh c√¥ng!');
            }
            closeTextEditModal();
        }
        
        // --- Helper functions for path management ---
        function autoSelectExtension() {
            const fileInput = document.getElementById('imageFileInput');
            const extSelect = document.getElementById('imageExtSelect');
            
            if (fileInput.files.length > 0) {
                const fileName = fileInput.files[0].name;
                const ext = fileName.substring(fileName.lastIndexOf('.')).toLowerCase();
                
                // Try to match with available options
                const options = Array.from(extSelect.options);
                const matchingOption = options.find(opt => opt.value === ext);
                
                if (matchingOption) {
                    extSelect.value = ext;
                }
            }
        }
        
        function updatePathPreview() {
            const folderSelect = document.getElementById('imageFolderSelect');
            const customFolderDiv = document.getElementById('customFolderDiv');
            
            // Show/hide custom folder input
            if (folderSelect.value === 'custom') {
                customFolderDiv.style.display = 'block';
            } else {
                customFolderDiv.style.display = 'none';
            }
            
            const fullPath = getFullPath();
            if (fullPath) {
                document.getElementById('pathPreviewText').innerText = fullPath;
                document.getElementById('pathPreview').style.display = 'block';
            } else {
                document.getElementById('pathPreview').style.display = 'none';
            }
        }
        
        function getFolderPath() {
            const folderSelect = document.getElementById('imageFolderSelect');
            if (folderSelect.value === 'custom') {
                let customPath = document.getElementById('customFolderInput').value.trim();
                // Ensure it ends with /
                if (customPath && !customPath.endsWith('/')) {
                    customPath += '/';
                }
                return customPath;
            }
            return folderSelect.value;
        }
        
        function getFullPath() {
            const folderPath = getFolderPath();
            let fileName = document.getElementById('imageNameInput').value.trim();
            const fileInput = document.getElementById('imageFileInput');
            const extSelect = document.getElementById('imageExtSelect');
            
            if (!fileName && fileInput.files.length > 0) {
                // Use original filename if no name provided
                return folderPath + fileInput.files[0].name;
            } else if (fileName) {
                // Remove any extension from fileName if user typed it
                fileName = fileName.replace(/\.(jpg|jpeg|png|gif|bmp|webp|svg)$/i, '');
                // Add selected extension
                const ext = extSelect.value;
                return folderPath + fileName + ext;
            }
            return '';
        }
        
        function validatePath(path, showAlert = false) {
            if (!path) {
                if (showAlert) alert('Vui l√≤ng ch·ªçn file v√† nh·∫≠p t√™n file!');
                return false;
            }
            
            // Check for invalid characters
            const invalidChars = /[<>:"|?*]/;
            if (invalidChars.test(path)) {
                if (showAlert) alert('ƒê∆∞·ªùng d·∫´n ch·ª©a k√Ω t·ª± kh√¥ng h·ª£p l·ªá: < > : " | ? *');
                return false;
            }
            
            // Check if it has a valid image extension
            const validExtensions = /\.(jpg|jpeg|png|gif|bmp|webp|svg)$/i;
            if (!validExtensions.test(path)) {
                if (showAlert) alert('File ph·∫£i c√≥ ƒëu√¥i ·∫£nh h·ª£p l·ªá (.jpg, .png, .gif, .webp, .svg, .bmp)');
                return false;
            }
            
            return true;
        }
        
        function saveToRecentPaths(folderPath) {
            if (!folderPath) return;
            
            let recentPaths = JSON.parse(localStorage.getItem('recentImagePaths') || '[]');
            
            // Remove if already exists
            recentPaths = recentPaths.filter(p => p !== folderPath);
            
            // Add to front
            recentPaths.unshift(folderPath);
            
            // Keep only 5 most recent
            recentPaths = recentPaths.slice(0, 5);
            
            localStorage.setItem('recentImagePaths', JSON.stringify(recentPaths));
        }
        
        function loadRecentPaths() {
            const recentPaths = JSON.parse(localStorage.getItem('recentImagePaths') || '[]');
            const folderSelect = document.getElementById('imageFolderSelect');
            
            // Remove old recent options
            const options = folderSelect.querySelectorAll('option');
            options.forEach(opt => {
                if (opt.value.startsWith('recent-')) {
                    opt.remove();
                }
            });
            
            // Add recent paths before 'custom' option
            const customOption = folderSelect.querySelector('option[value="custom"]');
            recentPaths.forEach((path, index) => {
                // Check if not already in standard options
                const existingOption = Array.from(folderSelect.options).find(opt => opt.value === path);
                if (!existingOption && path !== 'custom') {
                    const option = document.createElement('option');
                    option.value = path;
                    option.textContent = 'üìå ' + path;
                    folderSelect.insertBefore(option, customOption);
                }
            });
        }

        // --- X·ª≠ l√Ω Li√™n k·∫øt ---
        let currentEditingLink = null;
        let currentLinkType = null;

        function openLinkEditModal(type, btnElement) {
            currentLinkType = type;
            // Find the <a> tag sibling
            const parent = btnElement.parentElement;
            const linkElement = parent.querySelector('a');
            currentEditingLink = linkElement;
            
            const modal = document.getElementById('linkEditModal');
            const title = document.getElementById('linkEditTitle');
            const label = document.getElementById('linkEditLabel');
            const input = document.getElementById('linkEditInput');
            
            let currentVal = linkElement.getAttribute('href');
            
            if (type === 'phone') {
                title.innerText = 'Ch·ªânh s·ª≠a s·ªë ƒëi·ªán tho·∫°i';
                label.innerText = 'S·ªë ƒëi·ªán tho·∫°i m·ªõi';
                // Remove 'tel:' prefix for display
                if (currentVal && currentVal.startsWith('tel:')) {
                    currentVal = currentVal.substring(4);
                }
            } else if (type === 'youtube') {
                title.innerText = 'Ch·ªânh s·ª≠a link YouTube';
                label.innerText = 'Link YouTube m·ªõi';
            } else if (type === 'zalo') {
                title.innerText = 'Ch·ªânh s·ª≠a link Zalo';
                label.innerText = 'Link Zalo m·ªõi';
            } else if (type === 'facebook') {
                title.innerText = 'Ch·ªânh s·ª≠a link Facebook';
                label.innerText = 'Link Facebook m·ªõi';
            }
            
            input.value = currentVal;
            modal.style.display = 'block';
        }

        function closeLinkEditModal() {
            document.getElementById('linkEditModal').style.display = 'none';
            currentEditingLink = null;
            currentLinkType = null;
        }

        function updateLink() {
            if (currentEditingLink && currentLinkType) {
                let newVal = document.getElementById('linkEditInput').value.trim();
                const uid = currentEditingLink.getAttribute('data-uid');
                
                if (currentLinkType === 'phone') {
                    // Ensure it has tel: prefix
                    let hrefVal = newVal;
                    if (!hrefVal.startsWith('tel:')) {
                        hrefVal = 'tel:' + hrefVal;
                    }
                    currentEditingLink.setAttribute('href', hrefVal);
                    
                    // Save the full href
                    if(uid) saveContent(uid, hrefVal);
                    
                } else {
                    // For others, just update href
                    currentEditingLink.setAttribute('href', newVal);
                    if(uid) saveContent(uid, newVal);
                }

                alert('ƒê√£ c·∫≠p nh·∫≠t li√™n k·∫øt th√†nh c√¥ng!');
            }
            closeLinkEditModal();
        }
        
        function closeCertModal() {
            document.getElementById('certModal').style.display = 'none';
        }

        function updateCarouselForMobile() {
            const isMobile = window.innerWidth <= 768;
            
            if (isMobile) {
                slidesToShow = 2; 
                maxIndex = totalItems - slidesToShow;
            } else {
                slidesToShow = 3; 
                maxIndex = totalItems - slidesToShow;
            }
            
            if (currentCarouselIndex > maxIndex) {
                currentCarouselIndex = maxIndex;
            }
            updateCarousel();
            updateCarouselButtons();
        }

        function updateCertForMobile() {
            const isMobile = window.innerWidth <= 768;
            const certItems = document.querySelectorAll('.certificate-item');
            
            if (isMobile) {
                maxCertIndex = certItems.length - 1;
            }
            updateCertificate();
        }

        window.addEventListener('load', function() {
            updateCarouselForMobile();
            updateCertForMobile();
        });

        window.addEventListener('resize', function() {
            updateCarouselForMobile();
            updateCertForMobile();
        });

        // Unified Dropdown & Mobile Menu Logic
        document.addEventListener('DOMContentLoaded', function() {
        const dropdown = document.querySelector('.dropdown');
        if (!dropdown) return;

        const dropdownBtn = dropdown.querySelector('.dropdown-btn');
        const dropdownContent = dropdown.querySelector('.dropdown-content');
        
        // Store the original HTML of the main menu
        const originalMenuHTML = dropdownContent.innerHTML;

        // Data for building category views
        const categoryIcons = {
            'Gi∆∞·ªùng': 'icon-hinhdanhmuc/nhom-giuong.png',
            'Xe lƒÉn': 'icon-hinhdanhmuc/nhom-xelan.png',
            'Xe Scooter ƒëi·ªán': 'icon-hinhdanhmuc/nhom-xedien.png',
            'BƒÉng ca': 'icon-hinhdanhmuc/nhom-bangca.png',
            'T·ªß': 'icon-hinhdanhmuc/nhom-tu.png',
            'M√°y t·∫°o oxy': 'icon-hinhdanhmuc/nhom-maytaooxy.png',
            'M√°y ƒëo': 'icon-hinhdanhmuc/nhom-maydo.png',
            'M√°y x√¥ng': 'icon-hinhdanhmuc/nhom-xong.png',
            'M√°y h√∫t d·ªãch': 'icon-hinhdanhmuc/nhom-mayhutdich.png',
            'M√°y massage': 'icon-hinhdanhmuc/nhom-massage.png',
            'Thi·∫øt b·ªã t·∫≠p': 'icon-hinhdanhmuc/nhom-maytap.png',
            'N·ªám': 'icon-hinhdanhmuc/nhom-nem.png',
            'D·ª•ng c·ª• h·ªó tr·ª£': 'icon-hinhdanhmuc/nhom-dungcuhotro.png',
            'Thi·∫øt b·ªã y t·∫ø kh√°c': 'icon-hinhdanhmuc/nhom-thietbiyte.png'
        };

        // Function to generate the HTML for the product categories grid
        function createProductCategoryHTML() {
            let gridHTML = '<div class="mobile-category-grid">';
            Object.keys(categoryData).forEach(categoryName => {
                const iconPath = categoryIcons[categoryName] || '';
                gridHTML += `
                    <div class="mobile-category-item" data-category="${categoryName}">
                        <img src="${iconPath}" alt="${categoryName}" class="mobile-category-icon">
                        <span>${categoryName}</span>
                    </div>
                `;
            });
            gridHTML += '</div>';

            return `
                <div class="mobile-menu-header">
                    <button class="mobile-menu-back-btn">‚Äπ Quay l·∫°i</button>
                    <h3>Danh m·ª•c s·∫£n ph·∫©m</h3>
                </div>
                ${gridHTML}
            `;
        }
        
        // Function to generate sub-category list
        function createSubCategoryHTML(categoryName) {
            const subcategories = categoryData[categoryName] || [];
            let listHTML = '';
            if (subcategories.length > 0) {
                subcategories.forEach(sub => {
                    listHTML += `<div class="mobile-subcategory-item">${sub}</div>`;
                });
            } else {
                listHTML = '<div>Kh√¥ng c√≥ s·∫£n ph·∫©m con.</div>';
            }

            return `
                <div class="mobile-menu-header">
                    <button class="mobile-menu-back-btn" data-target="main-categories">‚Äπ Danh m·ª•c</button>
                    <h3>${categoryName}</h3>
                </div>
                <div class="mobile-subcategory-list">${listHTML}</div>
            `;
        }

        // Main click handler for the "Danh m·ª•c" button
        dropdownBtn.addEventListener('click', function(event) {
            if (window.innerWidth <= 768) {
                event.preventDefault();
                event.stopPropagation();
                dropdown.classList.toggle('mobile-menu-active');
            }
        });

        // Event delegation for handling clicks inside the mobile menu
        dropdownContent.addEventListener('click', function(event) {
            if (window.innerWidth > 768) return; // Only run on mobile

            const target = event.target;

            // Click on "S·∫£n ph·∫©m" to show product categories
            if (target.matches('.has-submenu')) {
                event.preventDefault();
                dropdownContent.innerHTML = createProductCategoryHTML();
            }

            // Click on the "Back" button
            if (target.matches('.mobile-menu-back-btn')) {
                const backTarget = target.getAttribute('data-target');
                if (backTarget === 'main-categories') {
                     dropdownContent.innerHTML = createProductCategoryHTML();
                } else {
                     dropdownContent.innerHTML = originalMenuHTML;
                }
            }

            // Click on a main product category to see sub-categories
            const categoryItem = target.closest('.mobile-category-item');
            if (categoryItem) {
                const categoryName = categoryItem.getAttribute('data-category');
                if (categoryName) {
                    dropdownContent.innerHTML = createSubCategoryHTML(categoryName);
                }
            }
            
            // Clicking a subcategory item should eventually lead to a new page
            const subCategoryItem = target.closest('.mobile-subcategory-item');
            if (subCategoryItem) {
                console.log('Navigate to:', subCategoryItem.textContent);
                // Example: window.location.href = '/path/to/category';
                dropdown.classList.remove('mobile-menu-active'); // Close menu
            }
        });

        // Close mobile menu when clicking outside
        document.addEventListener('click', function(event) {
            if (window.innerWidth <= 768) {
                if (!dropdown.contains(event.target)) {
                    dropdown.classList.remove('mobile-menu-active');
                }
            }
        });
        
         // Reset on resize
        window.addEventListener('resize', function() {
            dropdown.classList.remove('mobile-menu-active');
            dropdownContent.innerHTML = originalMenuHTML;
            // revert desktop hover behavior
            if (window.innerWidth > 768) {
                dropdownContent.style.display = '';
            }
        });
    });

    // Hi·ªáu ·ª©ng xu·∫•t hi·ªán t·ª´ t·ª´ (Reveal Animation)
    function reveal() {
        var reveals = document.querySelectorAll(".reveal");
        for (var i = 0; i < reveals.length; i++) {
            var windowHeight = window.innerHeight;
            var elementTop = reveals[i].getBoundingClientRect().top;
            var elementVisible = 50;
            if (elementTop < windowHeight - elementVisible) {
                reveals[i].classList.add("active");
            }
        }
    }
    window.addEventListener("scroll", reveal);
    // K√≠ch ho·∫°t ngay khi t·∫£i trang
    reveal();

    // ========== PROFILE MANAGEMENT FUNCTIONS ==========
    
    // Open/Close Profile Modal
    function openProfileModal() {
        document.getElementById('profileModal').style.display = 'block';
        document.getElementById('accountMenu').style.display = 'none'; // ƒê√≥ng menu t√†i kho·∫£n
        loadProfileData();
    }

    function closeProfileModal() {
        document.getElementById('profileModal').style.display = 'none';
    }

    // Toggle password visibility
    function togglePasswordVisibility() {
        const passwordField = document.getElementById('profilePassword');
        if (passwordField.type === 'password') {
            passwordField.type = 'text';
        } else {
            passwordField.type = 'password';
        }
    }

    // Load profile data from server
    function loadProfileData() {
        fetch('/get_profile.php')
            .then(response => response.json())
            .then(data => {
                console.log('Profile data received:', data);
                if (data.status === 'success') {
                    document.getElementById('profileUsername').value = data.username || '';
                    document.getElementById('profilePhone').value = data.phone || '';
                    document.getElementById('profileEmail').value = data.email || '';
                    document.getElementById('profileAddress').value = data.address || '';
                    document.getElementById('profilePassword').value = data.password || '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
                    
                    // Load avatar
                    if (data.avatar && data.avatar !== '') {
                        document.getElementById('profileAvatar').src = data.avatar;
                    }
                } else {
                    console.error('Error:', data.message);
                }
            })
            .catch(error => console.error('Error loading profile:', error));
    }

    // Enable editing for username
    function enableEdit(fieldId) {
        const field = document.getElementById(fieldId);
        field.readOnly = false;
        field.focus();
        field.style.backgroundColor = '#fff';
    }

    // Handle avatar upload
    function handleAvatarUpload(event) {
        const file = event.target.files[0];
        if (!file) return;

        // Validate file type
        if (!file.type.startsWith('image/')) {
            alert('Vui l√≤ng ch·ªçn file h√¨nh ·∫£nh!');
            return;
        }

        // Validate file size (max 5MB)
        if (file.size > 5 * 1024 * 1024) {
            alert('K√≠ch th∆∞·ªõc ·∫£nh kh√¥ng ƒë∆∞·ª£c v∆∞·ª£t qu√° 5MB!');
            return;
        }

        const formData = new FormData();
        formData.append('avatar', file);

        fetch('/upload_avatar.php', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                document.getElementById('profileAvatar').src = data.avatar_path;
                alert('C·∫≠p nh·∫≠t avatar th√†nh c√¥ng!');
            } else {
                alert(data.message || 'C√≥ l·ªói x·∫£y ra khi upload avatar!');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('C√≥ l·ªói x·∫£y ra!');
        });
    }

    // Save basic profile changes (username, address)
    function saveProfileChanges() {
        const username = document.getElementById('profileUsername').value;
        const address = document.getElementById('profileAddress').value;

        if (!username.trim()) {
            alert('T√™n ng∆∞·ªùi d√πng kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng!');
            return;
        }

        fetch('/update_profile.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                action: 'update_basic',
                username: username,
                address: address
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert('C·∫≠p nh·∫≠t th√¥ng tin th√†nh c√¥ng!');
                document.getElementById('profileUsername').readOnly = true;
                document.getElementById('profileUsername').style.backgroundColor = '#f5f5f5';
                
                // C·∫≠p nh·∫≠t username display
                document.getElementById('usernameDisplay').innerText = username;
            } else {
                alert(data.message || 'C√≥ l·ªói x·∫£y ra!');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('C√≥ l·ªói x·∫£y ra!');
        });
    }

    // Change Password Modal
    function openChangePasswordModal() {
        document.getElementById('changePasswordModal').style.display = 'block';
    }

    function closeChangePasswordModal() {
        document.getElementById('changePasswordModal').style.display = 'none';
        document.getElementById('oldPassword').value = '';
        document.getElementById('newPassword').value = '';
        document.getElementById('passwordVerifyCode').value = '';
    }

    function sendPasswordVerificationCode() {
        fetch('/send_verification_code.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ type: 'password' })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert('M√£ x√°c nh·∫≠n ƒë√£ ƒë∆∞·ª£c g·ª≠i ƒë·∫øn email c·ªßa b·∫°n!');
            } else {
                alert(data.message || 'Kh√¥ng th·ªÉ g·ª≠i m√£ x√°c nh·∫≠n!');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('C√≥ l·ªói x·∫£y ra!');
        });
    }

    function updatePassword() {
        const oldPassword = document.getElementById('oldPassword').value;
        const newPassword = document.getElementById('newPassword').value;
        const verifyCode = document.getElementById('passwordVerifyCode').value;

        if (!oldPassword || !newPassword || !verifyCode) {
            alert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin!');
            return;
        }

        if (newPassword.length < 6) {
            alert('M·∫≠t kh·∫©u m·ªõi ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±!');
            return;
        }

        fetch('/update_profile.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                action: 'update_password',
                old_password: oldPassword,
                new_password: newPassword,
                verify_code: verifyCode
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert('C·∫≠p nh·∫≠t m·∫≠t kh·∫©u th√†nh c√¥ng!');
                closeChangePasswordModal();
            } else {
                alert(data.message || 'C√≥ l·ªói x·∫£y ra!');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('C√≥ l·ªói x·∫£y ra!');
        });
    }

    // Change Phone Modal
    function openChangePhoneModal() {
        document.getElementById('changePhoneModal').style.display = 'block';
    }

    function closeChangePhoneModal() {
        document.getElementById('changePhoneModal').style.display = 'none';
        document.getElementById('newPhone').value = '';
        document.getElementById('phoneVerifyCode').value = '';
    }

    function sendPhoneVerificationCode() {
        const newPhone = document.getElementById('newPhone').value;

        if (!newPhone) {
            alert('Vui l√≤ng nh·∫≠p s·ªë ƒëi·ªán tho·∫°i m·ªõi!');
            return;
        }

        fetch('/send_verification_code.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ type: 'phone', phone: newPhone })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert('M√£ x√°c nh·∫≠n ƒë√£ ƒë∆∞·ª£c g·ª≠i ƒë·∫øn SƒêT m·ªõi!');
            } else {
                alert(data.message || 'Kh√¥ng th·ªÉ g·ª≠i m√£ x√°c nh·∫≠n!');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('C√≥ l·ªói x·∫£y ra!');
        });
    }

    function updatePhone() {
        const newPhone = document.getElementById('newPhone').value;
        const verifyCode = document.getElementById('phoneVerifyCode').value;

        if (!newPhone || !verifyCode) {
            alert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin!');
            return;
        }

        fetch('/update_profile.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                action: 'update_phone',
                phone: newPhone,
                verify_code: verifyCode
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert('C·∫≠p nh·∫≠t SƒêT th√†nh c√¥ng!');
                document.getElementById('profilePhone').value = newPhone;
                closeChangePhoneModal();
            } else {
                alert(data.message || 'C√≥ l·ªói x·∫£y ra!');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('C√≥ l·ªói x·∫£y ra!');
        });
    }

    // Change Email Modal
    function openChangeEmailModal() {
        document.getElementById('changeEmailModal').style.display = 'block';
    }

    function closeChangeEmailModal() {
        document.getElementById('changeEmailModal').style.display = 'none';
        document.getElementById('newEmail').value = '';
        document.getElementById('emailVerifyCode').value = '';
    }

    function sendEmailVerificationCode() {
        const newEmail = document.getElementById('newEmail').value;

        if (!newEmail) {
            alert('Vui l√≤ng nh·∫≠p email m·ªõi!');
            return;
        }

        fetch('/send_verification_code.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ type: 'email', email: newEmail })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert('M√£ x√°c nh·∫≠n ƒë√£ ƒë∆∞·ª£c g·ª≠i ƒë·∫øn email m·ªõi!');
            } else {
                alert(data.message || 'Kh√¥ng th·ªÉ g·ª≠i m√£ x√°c nh·∫≠n!');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('C√≥ l·ªói x·∫£y ra!');
        });
    }

    function updateEmail() {
        const newEmail = document.getElementById('newEmail').value;
        const verifyCode = document.getElementById('emailVerifyCode').value;

        if (!newEmail || !verifyCode) {
            alert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin!');
            return;
        }

        fetch('/update_profile.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                action: 'update_email',
                email: newEmail,
                verify_code: verifyCode
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert('C·∫≠p nh·∫≠t email th√†nh c√¥ng!');
                document.getElementById('profileEmail').value = newEmail;
                closeChangeEmailModal();
            } else {
                alert(data.message || 'C√≥ l·ªói x·∫£y ra!');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('C√≥ l·ªói x·∫£y ra!');
        });
    }

    // Close modals when clicking outside
    window.onclick = function(event) {
        const profileModal = document.getElementById('profileModal');
        const changePasswordModal = document.getElementById('changePasswordModal');
        const changePhoneModal = document.getElementById('changePhoneModal');
        const changeEmailModal = document.getElementById('changeEmailModal');

        if (event.target == profileModal) {
            closeProfileModal();
        }
        if (event.target == changePasswordModal) {
            closeChangePasswordModal();
        }
        if (event.target == changePhoneModal) {
            closeChangePhoneModal();
        }
        if (event.target == changeEmailModal) {
            closeChangeEmailModal();
        }
    };

    // Search functionality
    function removeVietnameseTones(str) {
        if (!str) return '';
        str = str.toLowerCase();
        str = str.replace(/√†|√°|·∫°|·∫£|√£|√¢|·∫ß|·∫•|·∫≠|·∫©|·∫´|ƒÉ|·∫±|·∫Ø|·∫∑|·∫≥|·∫µ/g, 'a');
        str = str.replace(/√®|√©|·∫π|·∫ª|·∫Ω|√™|·ªÅ|·∫ø|·ªá|·ªÉ|·ªÖ/g, 'e');
        str = str.replace(/√¨|√≠|·ªã|·ªâ|ƒ©/g, 'i');
        str = str.replace(/√≤|√≥|·ªç|·ªè|√µ|√¥|·ªì|·ªë|·ªô|·ªï|·ªó|∆°|·ªù|·ªõ|·ª£|·ªü|·ª°/g, 'o');
        str = str.replace(/√π|√∫|·ª•|·ªß|≈©|∆∞|·ª´|·ª©|·ª±|·ª≠|·ªØ/g, 'u');
        str = str.replace(/·ª≥|√Ω|·ªµ|·ª∑|·ªπ/g, 'y');
        str = str.replace(/ƒë/g, 'd');
        return str;
    }

    (function initSearch() {
        const searchInput = document.querySelector('.search-input');
        const searchBtn = document.querySelector('.search-btn');
        
        if (!searchInput || !searchBtn) return;
        
        searchBtn.addEventListener('click', () => {
            const query = searchInput.value.trim();
            if (query) {
                window.location.href = `quan-tri-vien-sanpham.html?search=${encodeURIComponent(query)}`;
            }
        });
        
        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                const query = searchInput.value.trim();
                if (query) {
                    window.location.href = `quan-tri-vien-sanpham.html?search=${encodeURIComponent(query)}`;
                }
            }
        });
    })();

    // Load Featured Products with Rating (admin view)
    (async function loadFeaturedProducts() {
        const grid = document.getElementById('featuredProductsGrid');
        if (!grid) return;

        function formatCurrency(val) {
            return val ? val.toLocaleString('vi-VN') + ' ‚Ç´' : 'ƒêang c·∫≠p nh·∫≠t';
        }

        try {
            const response = await fetch('api/admin_product_list.php');
            const data = await response.json();

            if (!data.success || !data.data) {
                throw new Error('Kh√¥ng th·ªÉ t·∫£i s·∫£n ph·∫©m');
            }

            const productsWithRating = data.data
                .filter(p => {
                    const sale = parseFloat(p.sale_price);
                    const price = parseFloat(p.price);
                    const original = parseFloat(p.original_price);

                    const validSale = !isNaN(sale) && sale > 0;
                    const validPrice = !isNaN(price) && price > 0;
                    const validOriginal = !isNaN(original) && original > 0;

                    return validSale || validPrice || validOriginal;
                })
                .map(p => ({
                    ...p,
                    rating: (Math.random() * 2 + 3).toFixed(1),
                    reviews: Math.floor(Math.random() * 500) + 10
                }));

            const topProducts = productsWithRating
                .sort((a, b) => parseFloat(b.rating) - parseFloat(a.rating))
                .slice(0, 12);

            grid.innerHTML = '';
            topProducts.forEach(p => {
                const card = document.createElement('div');
                card.className = 'product-card';
                card.style.cursor = 'pointer';
                card.onclick = () => window.location.href = 'quan-tri-vien-sanpham.html?id=' + p.id;
                
                const imgSrc = p.thumbnail_path || p.image || 'https://via.placeholder.com/300x200?text=Product';
                const salePrice = parseFloat(p.sale_price);
                const mainPrice = parseFloat(p.price);
                const originalPrice = parseFloat(p.original_price);
                const priceVal = (!isNaN(salePrice) && salePrice > 0)
                    ? salePrice
                    : (!isNaN(mainPrice) && mainPrice > 0)
                        ? mainPrice
                        : (!isNaN(originalPrice) && originalPrice > 0 ? originalPrice : 0);
                const originalVal = (!isNaN(originalPrice) && originalPrice > 0) ? originalPrice : 0;
                const showOriginal = originalVal && priceVal && originalVal > priceVal;
                const priceHtml = `
                    <div class="product-price">${priceVal ? formatCurrency(priceVal) : 'ƒêang c·∫≠p nh·∫≠t'}</div>
                    ${showOriginal ? `<div style="color: #6b7280; text-decoration: line-through; font-size: 13px; margin-top: 2px;">${formatCurrency(originalVal)}</div>` : ''}
                `;

                const rating = parseFloat(p.rating);
                const fullStars = Math.floor(rating);
                const hasHalfStar = rating % 1 >= 0.5;
                const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);

                let starsHTML = '';
                for (let i = 0; i < fullStars; i++) starsHTML += '<span style="color: #f59e0b;">‚òÖ</span>';
                if (hasHalfStar) starsHTML += '<span style="color: #f59e0b;">‚òÖ</span>';
                for (let i = 0; i < emptyStars; i++) starsHTML += '<span style="color: #e5e7eb;">‚òÖ</span>';

                card.innerHTML = `
                    <img src="${imgSrc}" alt="${p.name || ''}" onerror="this.src='https://via.placeholder.com/300x200?text=No+Image'">
                    <div class="product-name">${p.name || 'T√™n s·∫£n ph·∫©m'}</div>
                    ${priceHtml}
                    <div class="product-rating" style="color: #f59e0b; font-size: 13px; margin-top: 4px;">
                        ${starsHTML} <span style="color: #6b7280; font-size: 12px;">(${p.reviews})</span>
                    </div>
                    <div class="product-actions" style="display: flex; gap: 8px; margin-top: 8px;">
                        <button class="btn btn-outline" data-product-id="${p.id}" style="flex: 1; padding: 10px; font-size: 13px;">Xem chi ti·∫øt</button>
                        <button class="btn btn-primary" data-edit-id="${p.id}" style="flex: 1; padding: 10px; font-size: 13px;">S·ª≠a</button>
                    </div>
                `;

                card.onclick = null;
                const detailBtn = card.querySelector('[data-product-id]');
                if (detailBtn) {
                    detailBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        window.location.href = 'quan-tri-vien-sanpham.html?id=' + p.id;
                    });
                }

                const editBtn = card.querySelector('[data-edit-id]');
                if (editBtn) {
                    editBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        window.location.href = 'quan-tri-vien-sanpham.html?id=' + p.id;
                    });
                }

                grid.appendChild(card);
            });

        } catch (error) {
            console.error('Error loading featured products:', error);
            grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #666;">Kh√¥ng th·ªÉ t·∫£i s·∫£n ph·∫©m</div>';
        }
    })();

    </script>
    <style>
        .skeleton-item { animation: pulse 1.5s infinite; }
        .skeleton-img { width: 100%; height: 200px; background: #e0e0e0; border-radius: 8px; margin-bottom: 12px; }
        .skeleton-text { height: 16px; background: #e0e0e0; border-radius: 4px; margin-bottom: 8px; }
        .skeleton-text.short { width: 60%; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        .featured-products-wrapper { background: #fff; border-radius: 16px; padding: 24px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); border: 1px solid #e5e7eb; }
        .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 14px; }
        @media (min-width: 1200px) { .product-grid { grid-template-columns: repeat(4, 1fr); } }
        .product-card { background: #fff; border: 1px solid #e5e7eb; border-radius: 12px; padding: 12px; box-shadow: 0 4px 16px rgba(0,0,0,0.04); display: flex; flex-direction: column; gap: 8px; transition: transform 0.15s ease, box-shadow 0.15s ease; cursor: pointer; height: 400px; }
        .product-card:hover { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(0,0,0,0.08); border-color: #0d6efd; }
        .product-card img { width: 100%; height: 150px; object-fit: cover; border-radius: 10px; background: #f3f4f6; flex-shrink: 0; }
        .product-name { font-weight: 700; font-size: 15px; margin: 0; color: #111827; min-height: 40px; line-height: 1.3; }
        .product-price { color: #dc2626; font-weight: 800; font-size: 16px; margin-top: 4px; }
        .product-actions .btn { border-radius: 8px; border: 1px solid #d1d5db; background: #fff; cursor: pointer; }
        .product-actions .btn-primary { background: #0d6efd; color: #fff; border-color: #0d6efd; }
    </style>
    <script src="search-suggestions.js"></script>
</body>
    </html>